<!DOCTYPE html>  <html> <head>   <title>surround.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               surround.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <h1>#</h1>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">DOM</span> <span class="nx">Surround</span> <span class="nx">util</span>

<span class="nv">Author: </span><span class="nx">Alisue</span> <span class="p">(</span><span class="nx">lambdalisue@hashnote</span><span class="p">.</span><span class="nx">net</span><span class="p">)</span>
<span class="nv">License: </span><span class="nx">MIT</span> <span class="nx">License</span>

<span class="nx">Copyright</span> <span class="mi">2011</span> <span class="nx">hashnote</span><span class="p">.</span><span class="nx">net</span><span class="p">,</span> <span class="nx">Alisue</span> <span class="nx">allright</span> <span class="nx">reserved</span>

<span class="nv">Dependencies:</span>
  <span class="o">-</span> <span class="nx">DOMUtils</span> <span class="p">(</span><span class="nx">domutils</span><span class="p">.</span><span class="nx">coffee</span><span class="p">)</span>
  <span class="o">-</span> <span class="nx">Prerange</span> <span class="p">(</span><span class="nx">selection</span><span class="p">.</span><span class="nx">coffee</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <h1>#</h1>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">Surround = </span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>surround node with cover node
<node>xxx</node> -> <cover><node>xxx</node></cover></p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">out: </span><span class="nf">(node, cover) -&gt;</span>
    <span class="nv">cover = </span><span class="nx">cover</span><span class="p">.</span><span class="nx">cloneNode</span> <span class="kc">false</span>
    <span class="nv">nextSibling = </span><span class="nx">node</span><span class="p">.</span><span class="nx">nextSibling</span>
    <span class="nv">parentNode = </span><span class="nx">node</span><span class="p">.</span><span class="nx">parentNode</span>
    <span class="nx">cover</span><span class="p">.</span><span class="nx">appendChild</span> <span class="nx">node</span>
    <span class="nx">parentNode</span><span class="p">.</span><span class="nx">insertBefore</span> <span class="nx">cover</span><span class="p">,</span> <span class="nx">nextSibling</span>
    <span class="k">return</span> <span class="nx">cover</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>surround inside contents of node with cover node
<node>xxx</node> -> <node><cover>xxx</cover></node></p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">in</span><span class="o">:</span> <span class="nf">(node, cover) -&gt;</span>
    <span class="nv">cover = </span><span class="nx">cover</span><span class="p">.</span><span class="nx">cloneNode</span> <span class="kc">false</span>
    <span class="k">while</span> <span class="nx">node</span><span class="p">.</span><span class="nx">firstChild</span><span class="o">?</span>
      <span class="nx">cover</span><span class="p">.</span><span class="nx">appendChild</span> <span class="nx">node</span><span class="p">.</span><span class="nx">firstChild</span>
    <span class="nx">node</span><span class="p">.</span><span class="nx">appendChild</span> <span class="nx">cover</span>
    <span class="k">return</span> <span class="nx">node</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>replace surround node with cover node
<node>xxx</node> -> <cover>xxx</cover></p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">replace: </span><span class="nf">(node, cover) -&gt;</span>
    <span class="nv">cover = </span><span class="nx">cover</span><span class="p">.</span><span class="nx">cloneNode</span> <span class="kc">false</span>
    <span class="k">while</span> <span class="nx">node</span><span class="p">.</span><span class="nx">firstChild</span>
      <span class="nx">cover</span><span class="p">.</span><span class="nx">appendChild</span> <span class="nx">node</span><span class="p">.</span><span class="nx">firstChild</span>
    <span class="nv">parentNode = </span><span class="nx">node</span><span class="p">.</span><span class="nx">parentNode</span>
    <span class="nx">parentNode</span><span class="p">.</span><span class="nx">insertBefore</span> <span class="nx">cover</span><span class="p">,</span> <span class="nx">node</span>
    <span class="nx">parentNode</span><span class="p">.</span><span class="nx">removeChild</span> <span class="nx">node</span>
    <span class="k">return</span> <span class="nx">cover</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>remove surround node
<node>xxx</node> -> xxx</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">remove: </span><span class="nf">(node) -&gt;</span>
    <span class="nv">nextSibling = </span><span class="nx">node</span><span class="p">.</span><span class="nx">nextSibling</span>
    <span class="nv">parentNode = </span><span class="nx">node</span><span class="p">.</span><span class="nx">parentNode</span>
    <span class="nx">parentNode</span><span class="p">.</span><span class="nx">removeChild</span> <span class="nx">node</span>
    <span class="k">while</span> <span class="nx">node</span><span class="p">.</span><span class="nx">firstChild</span>
      <span class="nx">parentNode</span><span class="p">.</span><span class="nx">insertBefore</span> <span class="nx">node</span><span class="p">.</span><span class="nx">firstChild</span><span class="p">,</span> <span class="nx">nextSibling</span>
    <span class="k">return</span> <span class="nx">parentNode</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>surround each terminal node from start to end with cover node
<start><A>xxx</A></start><B><C>xxx</C></B><end>xxx</end> ->
<start><A><cover>xxx</cover></A></start><B><C><cover>xxx</cover></C></B><end><cover>xxx</cover></end></p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">each: </span><span class="nf">(start, end, cover, exclude=[], fn=Surround.out) -&gt;</span>
    <span class="nv">_fn = </span><span class="nf">(node) -&gt;</span>
      <span class="nx">fn</span> <span class="nx">node</span><span class="p">,</span> <span class="nx">cover</span> <span class="k">if</span> <span class="nx">node</span> <span class="o">not</span> <span class="k">in</span> <span class="nx">exclude</span> <span class="o">and</span> <span class="nx">DOMUtils</span><span class="p">.</span><span class="nx">isVisibleNode</span> <span class="nx">node</span>
    <span class="nx">DOMUtils</span><span class="p">.</span><span class="nx">applyToAllTerminalNodes</span> <span class="nx">start</span><span class="p">,</span> <span class="nx">end</span><span class="p">,</span> <span class="nx">_fn</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>research each terminal node from start to end with cover node
return report list and each report has <code>node</code> and <code>found</code> attribute.
<code>found</code> attribute set found compatible node with cover</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">research: </span><span class="nf">(start, end, cover, exclude=[]) -&gt;</span>
    <span class="nv">coverTagName = </span><span class="nx">cover</span><span class="p">.</span><span class="nx">tagName</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span>
    <span class="nv">test = </span><span class="nf">(node) -&gt;</span> <span class="nx">node</span><span class="p">.</span><span class="nx">tagName</span><span class="o">?</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span> <span class="o">is</span> <span class="nx">coverTagName</span>
    <span class="nv">reports = </span><span class="p">[]</span>
    <span class="nv">fn = </span><span class="nf">(node) -&gt;</span>
      <span class="k">if</span> <span class="nx">node</span> <span class="o">not</span> <span class="k">in</span> <span class="nx">exclude</span> <span class="o">and</span> <span class="nx">DOMUtils</span><span class="p">.</span><span class="nx">isVisibleNode</span> <span class="nx">node</span>
        <span class="nv">found = </span><span class="nx">DOMUtils</span><span class="p">.</span><span class="nx">findUpstreamNode</span> <span class="nx">node</span><span class="p">,</span> <span class="nx">test</span>
        <span class="nx">reports</span><span class="p">.</span><span class="nx">push</span> <span class="p">{</span>
          <span class="nv">node: </span><span class="nx">node</span><span class="p">,</span>
          <span class="nv">found: </span><span class="nx">found</span>
        <span class="p">}</span>
    <span class="nx">DOMUtils</span><span class="p">.</span><span class="nx">applyToAllTerminalNodes</span> <span class="nx">start</span><span class="p">,</span> <span class="nx">end</span><span class="p">,</span> <span class="nx">fn</span>
    <span class="k">return</span> <span class="nx">reports</span>
  <span class="nv">_container: </span><span class="nf">(node, cover) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>find upstream container node</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">test = </span><span class="nf">(node) -&gt;</span> <span class="nx">DOMUtils</span><span class="p">.</span><span class="nx">isBlockNode</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="o">and</span> <span class="nx">DOMUtils</span><span class="p">.</span><span class="nx">isContainerNode</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">)</span>
    <span class="nv">found = </span><span class="nx">DOMUtils</span><span class="p">.</span><span class="nx">findUpstreamNode</span> <span class="nx">node</span><span class="p">,</span> <span class="nx">test</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>container node can contain anything so just surround in</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">node = </span><span class="nx">Surround</span><span class="p">.</span><span class="nx">out</span> <span class="nx">found</span><span class="p">,</span> <span class="nx">cover</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>return Prerange instance</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">prerange = </span><span class="k">new</span> <span class="nx">Prerange</span>
    <span class="nx">prerange</span><span class="p">.</span><span class="nx">setStart</span> <span class="nx">node</span>
    <span class="nx">prerange</span><span class="p">.</span><span class="nx">setEnd</span> <span class="nx">node</span>
    <span class="k">return</span> <span class="nx">prerange</span>
  <span class="nv">_containerRemove: </span><span class="nf">(node, cover) -&gt;</span>
    <span class="nv">test = </span><span class="nf">(node) -&gt;</span> <span class="nx">DOMUtils</span><span class="p">.</span><span class="nx">isEqual</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">cover</span><span class="p">)</span>
    <span class="nv">found = </span><span class="nx">DOMUtils</span><span class="p">.</span><span class="nx">findUpstreamNode</span> <span class="nx">node</span><span class="p">,</span> <span class="nx">test</span>
    <span class="k">if</span> <span class="nx">found</span><span class="o">?</span>
      <span class="nv">start = </span><span class="nx">DOMUtils</span><span class="p">.</span><span class="nx">findPreviousNode</span> <span class="nx">found</span>
      <span class="nv">end = </span><span class="nx">DOMUtils</span><span class="p">.</span><span class="nx">findNextNode</span> <span class="nx">found</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>remove found block</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">Surround</span><span class="p">.</span><span class="nx">remove</span> <span class="nx">found</span>
      <span class="nv">prerange = </span><span class="k">new</span> <span class="nx">Prerange</span>
      <span class="nx">prerange</span><span class="p">.</span><span class="nx">setStart</span> <span class="nx">DOMUtils</span><span class="p">.</span><span class="nx">findNextNode</span><span class="p">(</span><span class="nx">start</span><span class="p">)</span>
      <span class="nx">prerange</span><span class="p">.</span><span class="nx">setEnd</span> <span class="nx">DOMUtils</span><span class="p">.</span><span class="nx">findPreviousNode</span><span class="p">(</span><span class="nx">end</span><span class="p">)</span>
      <span class="k">return</span> <span class="nx">prerange</span>
    <span class="k">else</span>
      <span class="nv">prerange = </span><span class="k">new</span> <span class="nx">Prerange</span>
      <span class="nx">prerange</span><span class="p">.</span><span class="nx">setStart</span> <span class="nx">node</span>
      <span class="nx">prerange</span><span class="p">.</span><span class="nx">setEnd</span> <span class="nx">node</span>
      <span class="k">return</span> <span class="nx">prerange</span>
  <span class="nv">_block: </span><span class="nf">(node, cover, paragraph=true) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>find upstream block node</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">test = </span><span class="nf">(node) -&gt;</span> <span class="nx">DOMUtils</span><span class="p">.</span><span class="nx">isBlockNode</span> <span class="nx">node</span>
    <span class="nv">found = </span><span class="nx">DOMUtils</span><span class="p">.</span><span class="nx">findUpstreamNode</span> <span class="nx">node</span><span class="p">,</span> <span class="nx">test</span>
    <span class="k">if</span> <span class="nx">found</span><span class="o">?</span>
      <span class="k">if</span> <span class="nx">DOMUtils</span><span class="p">.</span><span class="nx">isEqual</span><span class="p">(</span><span class="nx">found</span><span class="p">,</span> <span class="nx">cover</span><span class="p">)</span>
        <span class="k">if</span> <span class="nx">paragraph</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>replace with paragraph block</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="nv">node = </span><span class="nx">Surround</span><span class="p">.</span><span class="nx">replace</span> <span class="nx">found</span><span class="p">,</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">)</span>
        <span class="k">else</span>
          <span class="nv">start = </span><span class="nx">DOMUtils</span><span class="p">.</span><span class="nx">findPreviousNode</span> <span class="nx">found</span>
          <span class="nv">end = </span><span class="nx">DOMUtils</span><span class="p">.</span><span class="nx">findNextNode</span> <span class="nx">found</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>remove found block</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="nx">Surround</span><span class="p">.</span><span class="nx">remove</span> <span class="nx">found</span>
          <span class="nv">prerange = </span><span class="k">new</span> <span class="nx">Prerange</span>
          <span class="nx">prerange</span><span class="p">.</span><span class="nx">setStart</span> <span class="nx">DOMUtils</span><span class="p">.</span><span class="nx">findNextNode</span><span class="p">(</span><span class="nx">start</span><span class="p">)</span>
          <span class="nx">prerange</span><span class="p">.</span><span class="nx">setEnd</span> <span class="nx">DOMUtils</span><span class="p">.</span><span class="nx">findPreviousNode</span><span class="p">(</span><span class="nx">end</span><span class="p">)</span>
          <span class="k">return</span> <span class="nx">prerange</span>
      <span class="k">else</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>replace with cover block</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nv">node = </span><span class="nx">Surround</span><span class="p">.</span><span class="nx">replace</span> <span class="nx">found</span><span class="p">,</span> <span class="nx">cover</span>
    <span class="k">else</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>find upstream container node</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">test = </span><span class="nf">(node) -&gt;</span> <span class="nx">DOMUtils</span><span class="p">.</span><span class="nx">isContainerNode</span> <span class="nx">node</span>
      <span class="nv">found = </span><span class="nx">DOMUtils</span><span class="p">.</span><span class="nx">findUpstreamNode</span> <span class="nx">node</span><span class="p">,</span> <span class="nx">test</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>container node can contain anything so just surround in</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">node = </span><span class="nx">Surround</span><span class="p">.</span><span class="k">in</span> <span class="nx">found</span><span class="p">,</span> <span class="nx">cover</span>
    <span class="nv">prerange = </span><span class="k">new</span> <span class="nx">Prerange</span>
    <span class="nx">prerange</span><span class="p">.</span><span class="nx">setStart</span> <span class="nx">node</span>
    <span class="nx">prerange</span><span class="p">.</span><span class="nx">setEnd</span> <span class="nx">node</span>
    <span class="k">return</span> <span class="nx">prerange</span>
  <span class="nv">_inline: </span><span class="nf">(root, start, end, cover) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>find upstream compatible inline node</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">test = </span><span class="nf">(node) -&gt;</span> <span class="nx">DOMUtils</span><span class="p">.</span><span class="nx">isEqual</span> <span class="nx">node</span><span class="p">,</span> <span class="nx">cover</span>
    <span class="nv">found = </span><span class="nx">DOMUtils</span><span class="p">.</span><span class="nx">findUpstreamNode</span> <span class="nx">root</span><span class="p">,</span> <span class="nx">test</span>
    <span class="k">if</span> <span class="nx">found</span><span class="o">?</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>Most complicated pattern. This pattern have to handle out node of range
as well (sometime). Remove found cover node and resurround each downstream
terminal node of found cover node except selected range
store firstChild and lastChild before remove found node</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">firstChild = </span><span class="nx">found</span><span class="p">.</span><span class="nx">firstChild</span>
      <span class="nv">lastChild = </span><span class="nx">found</span><span class="p">.</span><span class="nx">lastChild</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>Remove surround node</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">root = </span><span class="nx">Surround</span><span class="p">.</span><span class="nx">remove</span> <span class="nx">found</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>find exclude nodes</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">exclude = </span><span class="p">[]</span>
      <span class="nv">fn = </span><span class="nf">(node) -&gt;</span>
        <span class="nx">exclude</span><span class="p">.</span><span class="nx">push</span> <span class="nx">node</span>
      <span class="nx">DOMUtils</span><span class="p">.</span><span class="nx">applyToAllTerminalNodes</span> <span class="nx">start</span><span class="p">,</span> <span class="nx">end</span><span class="p">,</span> <span class="nx">fn</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>Re-surround except nodes in exclude</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">Surround</span><span class="p">.</span><span class="nx">each</span> <span class="nx">firstChild</span><span class="p">,</span> <span class="nx">lastChild</span><span class="p">,</span> <span class="nx">cover</span><span class="p">,</span> <span class="nx">exclude</span>
      <span class="k">if</span> <span class="nx">start</span> <span class="o">is</span> <span class="nx">end</span> <span class="o">and</span> <span class="nx">DOMUtils</span><span class="p">.</span><span class="nx">isDataNode</span><span class="p">(</span><span class="nx">start</span><span class="p">)</span>
        <span class="nv">previousSibling = </span><span class="nx">start</span><span class="p">.</span><span class="nx">previousSibling</span>
        <span class="k">if</span> <span class="nx">previousSibling</span><span class="o">?</span> <span class="o">and</span> <span class="nx">DOMUtils</span><span class="p">.</span><span class="nx">isDataNode</span><span class="p">(</span><span class="nx">previousSibling</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>HTMLTidy will concat the previousSibling and start node because both
of them is DataNode. That's why the storategy of set start/end node
to prerange doesn't work at all. What things need to do is that
concat previousSibling and start node manually and return start/end
with offset which can be calculated by each DataNode length</p>

<p>Note:
  I check only <code>previousSibling</code> because DOMUtils.concatDataNode
  doesn't remove lhs node (It only remove rhs node and modify lhs
  nodeValue and return lhs) so even if there are only nextSibling,
  start/end node isn't affected by HTMLTidy</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="nv">node = </span><span class="nx">start</span>
          <span class="nv">start = </span><span class="k">if</span> <span class="nx">previousSibling</span><span class="o">?</span> <span class="k">then</span> <span class="nx">previousSibling</span><span class="p">.</span><span class="nx">length</span> <span class="k">else</span> <span class="mi">0</span>
          <span class="nv">end = </span><span class="nx">start</span> <span class="o">+</span> <span class="nx">node</span><span class="p">.</span><span class="nx">length</span>
          <span class="nv">node = </span><span class="nx">DOMUtils</span><span class="p">.</span><span class="nx">concatDataNode</span> <span class="nx">previousSibling</span><span class="p">,</span> <span class="nx">node</span>
          <span class="nv">prerange = </span><span class="k">new</span> <span class="nx">Prerange</span>
          <span class="nx">prerange</span><span class="p">.</span><span class="nx">setStart</span> <span class="nx">node</span><span class="p">,</span> <span class="nx">start</span>
          <span class="nx">prerange</span><span class="p">.</span><span class="nx">setEnd</span> <span class="nx">node</span><span class="p">,</span> <span class="nx">end</span>
          <span class="k">return</span> <span class="nx">prerange</span>
      <span class="nv">prerange = </span><span class="k">new</span> <span class="nx">Prerange</span>
      <span class="nx">prerange</span><span class="p">.</span><span class="nx">setStart</span> <span class="nx">start</span>
      <span class="nx">prerange</span><span class="p">.</span><span class="nx">setEnd</span> <span class="nx">end</span>
      <span class="k">return</span> <span class="nx">prerange</span>
    <span class="k">else</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>No inclusion cover node is found. Apply surround to each terminal node</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">reports = </span><span class="nx">Surround</span><span class="p">.</span><span class="nx">research</span> <span class="nx">start</span><span class="p">,</span> <span class="nx">end</span><span class="p">,</span> <span class="nx">cover</span>
      <span class="nv">removeMode = </span><span class="kc">true</span>
      <span class="k">for</span> <span class="nx">report</span> <span class="k">in</span> <span class="nx">reports</span>
        <span class="k">if</span> <span class="o">not</span> <span class="nx">report</span><span class="p">.</span><span class="nx">found</span><span class="o">?</span>
          <span class="nv">removeMode = </span><span class="kc">false</span>
          <span class="k">break</span>
      <span class="k">if</span> <span class="nx">removeMode</span>
        <span class="k">for</span> <span class="nx">report</span> <span class="k">in</span> <span class="nx">reports</span>
          <span class="k">if</span> <span class="nx">report</span><span class="p">.</span><span class="nx">found</span><span class="o">?</span>
            <span class="nx">Surround</span><span class="p">.</span><span class="nx">remove</span> <span class="nx">report</span><span class="p">.</span><span class="nx">found</span>
      <span class="k">else</span>
        <span class="k">for</span> <span class="nx">report</span> <span class="k">in</span> <span class="nx">reports</span>
          <span class="k">if</span> <span class="o">not</span> <span class="nx">report</span><span class="p">.</span><span class="nx">found</span><span class="o">?</span>
            <span class="nx">Surround</span><span class="p">.</span><span class="nx">out</span> <span class="nx">report</span><span class="p">.</span><span class="nx">node</span><span class="p">,</span> <span class="nx">cover</span>
      <span class="nv">prerange = </span><span class="k">new</span> <span class="nx">Prerange</span>
      <span class="nx">prerange</span><span class="p">.</span><span class="nx">setStart</span> <span class="nx">start</span>
      <span class="nx">prerange</span><span class="p">.</span><span class="nx">setEnd</span> <span class="nx">end</span>
      <span class="k">return</span> <span class="nx">prerange</span>
  <span class="nv">range: </span><span class="nf">(range, cover, remove=false) -&gt;</span>
    <span class="k">if</span> <span class="nx">DOMUtils</span><span class="p">.</span><span class="nx">isContainerNode</span> <span class="nx">cover</span>
      <span class="k">if</span> <span class="nx">remove</span>
        <span class="k">return</span> <span class="nx">Surround</span><span class="p">.</span><span class="nx">_containerRemove</span> <span class="nx">range</span><span class="p">.</span><span class="nx">commonAncestorContainer</span><span class="p">,</span> <span class="nx">cover</span>
      <span class="k">else</span>
        <span class="k">return</span> <span class="nx">Surround</span><span class="p">.</span><span class="nx">_container</span> <span class="nx">range</span><span class="p">.</span><span class="nx">commonAncestorContainer</span><span class="p">,</span> <span class="nx">cover</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">DOMUtils</span><span class="p">.</span><span class="nx">isBlockNode</span> <span class="nx">cover</span>
      <span class="k">return</span> <span class="nx">Surround</span><span class="p">.</span><span class="nx">_block</span> <span class="nx">range</span><span class="p">.</span><span class="nx">commonAncestorContainer</span><span class="p">,</span> <span class="nx">cover</span>
    <span class="k">else</span>
      <span class="nv">startContainer = </span><span class="nx">range</span><span class="p">.</span><span class="nx">startContainer</span>
      <span class="nv">startOffset = </span><span class="nx">range</span><span class="p">.</span><span class="nx">startOffset</span>
      <span class="nv">endContainer = </span><span class="nx">range</span><span class="p">.</span><span class="nx">endContainer</span>
      <span class="nv">endOffset = </span><span class="nx">range</span><span class="p">.</span><span class="nx">endOffset</span>
      <span class="nv">root = </span><span class="nx">range</span><span class="p">.</span><span class="nx">commonAncestorContainer</span>
      <span class="k">if</span> <span class="nx">startContainer</span> <span class="o">is</span> <span class="nx">endContainer</span> <span class="o">and</span> <span class="nx">DOMUtils</span><span class="p">.</span><span class="nx">isDataNode</span> <span class="nx">startContainer</span>
        <span class="nv">start = end = </span><span class="nx">DOMUtils</span><span class="p">.</span><span class="nx">extractDataNode</span><span class="p">(</span><span class="nx">startContainer</span><span class="p">,</span> <span class="nx">startOffset</span><span class="p">,</span> <span class="nx">endOffset</span><span class="p">)</span>
        <span class="nv">root = </span><span class="nx">start</span><span class="p">.</span><span class="nx">parentNode</span>
      <span class="k">else</span>
        <span class="k">if</span> <span class="nx">DOMUtils</span><span class="p">.</span><span class="nx">isDataNode</span> <span class="nx">startContainer</span>
          <span class="nv">start = </span><span class="nx">DOMUtils</span><span class="p">.</span><span class="nx">extractDataNode</span><span class="p">(</span><span class="nx">startContainer</span><span class="p">,</span> <span class="nx">startOffset</span><span class="p">)</span>
        <span class="k">else</span>
          <span class="nv">start = </span><span class="nx">startContainer</span><span class="p">.</span><span class="nx">childNodes</span><span class="p">[</span><span class="nx">startOffset</span><span class="p">]</span>
        <span class="k">if</span> <span class="nx">DOMUtils</span><span class="p">.</span><span class="nx">isDataNode</span> <span class="nx">endContainer</span>
          <span class="nv">end = </span><span class="nx">DOMUtils</span><span class="p">.</span><span class="nx">extractDataNode</span><span class="p">(</span><span class="nx">endContainer</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">endOffset</span><span class="p">)</span>
        <span class="k">else</span>
          <span class="nv">end = </span><span class="nx">endContainer</span><span class="p">.</span><span class="nx">childNodes</span><span class="p">[</span><span class="nx">endOffset</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
      <span class="k">return</span> <span class="nx">Surround</span><span class="p">.</span><span class="nx">_inline</span> <span class="nx">root</span><span class="p">,</span> <span class="nx">start</span><span class="p">,</span> <span class="nx">end</span><span class="p">,</span> <span class="nx">cover</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 