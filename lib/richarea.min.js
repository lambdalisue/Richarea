/*!
 * Richarea - A JavaScript contentEditable munipulator library v0.2.0
 * http://github.com/lambdalisue/Richarea
 * 
 * Copyright 2011 (c) hashnote.net, Alisue allright reserved.
 * Licensed under the MIT license.
 * 
 * Last-Modified: Mon, 07 Nov 2011 13:03:46 GMT
 */
(function(){function m(g){this._document=g;this.startContainer=this.endContainer=g.body;this.endOffset=i.getNodeLength(g.body)}function b(g){this.range=g;if(!g.collapsed){var b=g.commonAncestorContainer;this._next=g.startContainer==b&&!i.isDataNode(g.startContainer)?g.startContainer.childNodes[g.startOffset]:i.findClosestAncestor(b,g.startContainer);this._end=g.endContainer==b&&!i.isDataNode(g.endContainer)?g.endContainer.childNodes[g.endOffset]:i.findClosestAncestor(b,g.endContainer).nextSibling}}
function q(g){this._document=g;var b=this;g.attachEvent("onselectionchange",function(){b._selectionChangeHandler()})}var i={findChildPosition:function(g){for(var b=0;g=g.previousSibling;b++);return b},isDataNode:function(g){return g&&g.nodeValue!==null&&g.data!==null},isAncestorOf:function(g,b){return!i.isDataNode(g)&&(g.contains(i.isDataNode(b)?b.parentNode:b)||b.parentNode==g)},isAncestorOrSelf:function(g,b){return i.isAncestorOf(g,b)||g==b},findClosestAncestor:function(g,b){if(i.isAncestorOf(g,
b))for(;b&&b.parentNode!=g;)b=b.parentNode;return b},getNodeLength:function(b){return i.isDataNode(b)?b.length:b.childNodes.length},splitDataNode:function(b,h){if(!i.isDataNode(b))return!1;var j=b.cloneNode(!1);b.deleteData(h,b.length);j.deleteData(0,h);b.parentNode.insertBefore(j,b.nextSibling)}},n={convertToDOMRange:function(b,h){function i(b,g,l){var a=h.createElement("a"),e=g.duplicate();e.collapse(l);var c=e.parentElement();do c.insertBefore(a,a.previousSibling),e.moveToElementText(a);while(e.compareEndPoints(l?
"StartToStart":"StartToEnd",g)>0&&a.previousSibling);if(e.compareEndPoints(l?"StartToStart":"StartToEnd",g)==-1&&a.nextSibling)e.setEndPoint(l?"EndToStart":"EndToEnd",g),b[l?"setStart":"setEnd"](a.nextSibling,e.text.length);else b[l?"setStartBefore":"setEndBefore"](a);a.parentNode.removeChild(a)}var l=new m(h);i(l,b,!0);i(l,b,!1);return l},convertFromDOMRange:function(b){function h(b,g,h){var j=g[h?"startContainer":"endContainer"],a=g[h?"startOffset":"endOffset"],e=0,c=i.isDataNode(j)?j:a===j.childNodes.length?
null:j.childNodes[a],d=i.isDataNode(j)?j.parentNode:j;if(j.nodeType==3||j.nodeType==4)e=a;j=g._document.createElement("a");d.insertBefore(j,c);g=g._document.body.createTextRange();g.moveToElementText(j);j.parentNode.removeChild(j);b.setEndPoint(h?"StartToStart":"EndToStart",g);b[h?"moveStart":"moveEnd"]("character",e)}var j=b._document.body.createTextRange();h(j,b,!0);h(j,b,!1);return j}};m.START_TO_START=0;m.START_TO_END=1;m.END_TO_END=2;m.END_TO_START=3;m.prototype={startContainer:null,startOffset:0,
endContainer:null,endOffset:0,commonAncestorContainer:null,collapsed:!1,_document:null,_refreshProperties:function(){this.collapsed=this.startContainer==this.endContainer&&this.startOffset==this.endOffset;for(var b=this.startContainer;b&&b!=this.endContainer&&!i.isAncestorOf(b,this.endContainer);)b=b.parentNode;this.commonAncestorContainer=b},setStart:function(b,h){this.startContainer=b;this.startOffset=h;this._refreshProperties()},setEnd:function(b,h){this.endContainer=b;this.endOffset=h;this._refreshProperties()},
setStartBefore:function(b){this.setStart(b.parentNode,i.findChildPosition(b))},setStartAfter:function(b){this.setStart(b.parentNode,i.findChildPosition(b)+1)},setEndBefore:function(b){this.setEnd(b.parentNode,i.findChildPosition(b))},setEndAfter:function(b){this.setEnd(b.parentNode,i.findChildPosition(b)+1)},selectNode:function(b){this.setStartBefore(b);this.setEndAfter(b)},selectNodeContents:function(b){this.setStart(b,0);this.setEnd(b,i.getNodeLength(b))},collapse:function(b){b?this.setEnd(this.startContainer,
this.startOffset):this.setStart(this.endContainer,this.endOffset)},cloneContents:function(){return function h(b){for(var i,k=document.createDocumentFragment();i=b.next();)i=i.cloneNode(!b.hasPartialSubtree()),b.hasPartialSubtree()&&i.appendChild(h(b.getSubtreeIterator())),k.appendChild(i);return k}(new b(this))},extractContents:function(){var g=this.cloneRange();this.startContainer!=this.commonAncestorContainer&&this.setStartAfter(i.findClosestAncestor(this.commonAncestorContainer,this.startContainer));
this.collapse(!0);return function j(b){for(var g,i=document.createDocumentFragment();g=b.next();)b.hasPartialSubtree()?g=g.cloneNode(!1):b.remove(),b.hasPartialSubtree()&&g.appendChild(j(b.getSubtreeIterator())),i.appendChild(g);return i}(new b(g))},deleteContents:function(){var g=this.cloneRange();this.startContainer!=this.commonAncestorContainer&&this.setStartAfter(i.findClosestAncestor(this.commonAncestorContainer,this.startContainer));this.collapse(!0);(function j(b){for(;b.next();)b.hasPartialSubtree()?
j(b.getSubtreeIterator()):b.remove()})(new b(g))},insertNode:function(b){i.isDataNode(this.startContainer)?(i.splitDataNode(this.startContainer,this.startOffset),this.startContainer.parentNode.insertBefore(b,this.startContainer.nextSibling)):this.startContainer.insertBefore(b,this.startContainer.childNodes[this.startOffset]);this.setStart(this.startContainer,this.startOffset)},surroundContents:function(b){var h=this.extractContents();this.insertNode(b);console.log(this);b.appendChild(h);this.selectNode(b)},
compareBoundaryPoints:function(b,h){var i,l,k,n;switch(b){case m.START_TO_START:case m.START_TO_END:i=this.startContainer;l=this.startOffset;break;case m.END_TO_END:case m.END_TO_START:i=this.endContainer,l=this.endOffset}switch(b){case m.START_TO_START:case m.END_TO_START:k=h.startContainer;n=h.startOffset;break;case m.START_TO_END:case m.END_TO_END:k=h.endContainer,n=h.endOffset}return i.sourceIndex<k.sourceIndex?-1:i.sourceIndex==k.sourceIndex?l<n?-1:l==n?0:1:1},cloneRange:function(){var b=new m(this._document);
b.setStart(this.startContainer,this.startOffset);b.setEnd(this.endContainer,this.endOffset);return b},detach:function(){},toString:function(){return n.convertFromDOMRange(this).text},createContextualFragment:function(b){var h=(i.isDataNode(this.startContainer)?this.startContainer.parentNode:this.startContainer).cloneNode(!1);h.innerHTML=b;for(b=this._document.createDocumentFragment();h.firstChild;)b.appendChild(h.firstChild);return b}};b.prototype={range:null,_current:null,_next:null,_end:null,hasNext:function(){return!!this._next},
next:function(){var b=this._current=this._next;this._next=this._current&&this._current.nextSibling!=this._end?this._current.nextSibling:null;i.isDataNode(this._current)&&(this.range.endContainer==this._current&&(b=b.cloneNode(!0)).deleteData(this.range.endOffset,b.length-this.range.endOffset),this.range.startContainer==this._current&&(b=b.cloneNode(!0)).deleteData(0,this.range.startOffset));return b},remove:function(){if(i.isDataNode(this._current)&&(this.range.startContainer==this._current||this.range.endContainer==
this._current)){var b=this.range.startContainer==this._current?this.range.startOffset:0;this._current.deleteData(b,(this.range.endContainer==this._current?this.range.endOffset:this._current.length)-b)}else this._current.parentNode.removeChild(this._current)},hasPartialSubtree:function(){return!i.isDataNode(this._current)&&(i.isAncestorOrSelf(this._current,this.range.startContainer)||i.isAncestorOrSelf(this._current,this.range.endContainer))},getSubtreeIterator:function(){var g=new m(this.range._document);
g.selectNodeContents(this._current);i.isAncestorOrSelf(this._current,this.range.startContainer)&&g.setStart(this.range.startContainer,this.range.startOffset);i.isAncestorOrSelf(this._current,this.range.endContainer)&&g.setEnd(this.range.endContainer,this.range.endOffset);return new b(g)}};q.prototype={rangeCount:0,_document:null,_selectionChangeHandler:function(){this.rangeCount=this._selectionExists(this._document.selection.createRange())?1:0},_selectionExists:function(b,h){h===void 0&&(h=!0);return b.compareEndPoints("StartToEnd",
b)!=0||b.parentElement().isContentEditable&&h},addRange:function(b){var h=this._document.selection.createRange(),b=n.convertFromDOMRange(b);this._selectionExists(h,!1)?(b.compareEndPoints("StartToStart",h)==-1&&(b.compareEndPoints("StartToEnd",h)>-1&&b.compareEndPoints("EndToEnd",h)==-1?h.setEndPoint("StartToStart",b):b.compareEndPoints("EndToStart",h)<1&&b.compareEndPoints("EndToEnd",h)>-1&&h.setEndPoint("EndToEnd",b)),h.select()):b.select()},removeAllRanges:function(){this._document.selection.empty()},
getRangeAt:function(){var b=this._document.selection.createRange();return this._selectionExists(b)?n.convertToDOMRange(b,this._document):null},toString:function(){return this._document.selection.createRange().text}};if(window.getSelection===void 0){document.createRange=function(){return new m(document)};var o=new q(document);window.getSelection=function(){return o};window.DOMRange=m;window.DOMSelection=q}})();
(function(){var m,b,q,i,n,o,g,h,j,l=Array.prototype.indexOf||function(a){for(var e=0,c=this.length;e<c;e++)if(this[e]===a)return e;return-1},k=function(a,e){return function(){return a.apply(e,arguments)}},t=Object.prototype.hasOwnProperty,s=function(a,e){function c(){this.constructor=a}for(var b in e)t.call(e,b)&&(a[b]=e[b]);c.prototype=e.prototype;a.prototype=new c;a.__super__=e.prototype;return a};q=function(){function a(){this.browser=this.searchString(a.dataBrowser)||"An unknown browser";this.version=
this.searchVersion(navigator.userAgent)||this.searchVersion(navigator.appVersion)||"An unknown browser";this.OS=this.searchString(a.dataOS)||"An unknown OS"}a.prototype.searchString=function(a){var b,d,f;for(d=0,f=a.length;d<f;d++)if(b=a[d],this.versionSearchString=b.versionSearch||b.identify,b.string!=null)if(b.string.indexOf(b.subString)!==-1)return b.identify;else if(b.prop)return b.identify;return[]};a.prototype.searchVersion=function(a){var b;b=a.indexOf(this.versionSearchString);return b===
-1?void 0:parseFloat(a.substring(b+this.versionSearchString.length+1))};a.dataBrowser=[{string:navigator.userAgent,subString:"Chrome",identify:"Chrome"},{string:navigator.userAgent,subString:"OmniWeb",versionSearch:"OmniWeb/",identify:"OmniWeb"},{string:navigator.vendor,subString:"Apple",identify:"Safari",versionSearch:"Version"},{prop:window.opera,identify:"Opera",versionSearch:"Version"},{string:navigator.vendor,subString:"iCab",identify:"iCab"},{string:navigator.vendor,subString:"KDE",identify:"Konqueror"},
{string:navigator.userAgent,subString:"Firefox",identify:"Firefox"},{string:navigator.vendor,subString:"Camino",identify:"Camino"},{string:navigator.userAgent,subString:"Netscape",identify:"Netscape"},{string:navigator.userAgent,subString:"MSIE",identify:"Explorer",versionSearch:"MSIE"},{string:navigator.userAgent,subString:"Gecko",identify:"Mozilla",versionSearch:"rv"},{string:navigator.userAgent,subString:"Mozilla",identify:"Netscape",versionSearch:"Mozilla"}];a.dataOS=[{string:navigator.platform,
subString:"Win",identify:"Windows"},{string:navigator.platform,subString:"Mac",identify:"Mac"},{string:navigator.userAgent,subString:"iPhone",identify:"iPhone/iPad"},{string:navigator.platform,subString:"Linux",identify:"Linux"}];return a}();if(typeof exports!=="undefined"&&exports!==null)exports.Detector=q;j=function(a,e){var b,d;for(d in e)b=e[d],a.prototype[d]=b;return a};if(typeof exports!=="undefined"&&exports!==null)exports.partial=j;i=function(){function a(a){this.target=a;this._eventListeners=
{}}a.prototype.addEventListener=function(a,b){this._eventListeners[a]==null&&(this._eventListeners[a]=[]);return this._eventListeners[a].push(b)};a.prototype.removeEventListener=function(a,b){var d,f,r,h,g;if(this._eventListeners[a]instanceof Array){f=this._eventListeners[a];g=[];for(d=0,r=f.length;d<r;d++)if(h=f[d],h===b){f.splice(d,1);break}return g}};a.prototype.bind=function(a,b){var d,f,r,h,a=a.split(" ");h=[];for(f=0,r=a.length;f<r;f++)d=a[f],h.push(this.addEventListener(d,b));return h};a.prototype.unbind=
function(a,b){var d,f,h,g,a=a.split(" ");g=[];for(f=0,h=a.length;f<h;f++)d=a[f],g.push(this.removeEventListener(d,b));return g};a.prototype.fire=function(a){var b,d,f,h,g;typeof a==="string"&&(a={type:a});if(a.target==null)a.target=this.target||this;if(a.type==null)throw Error("Event objet missing `type` property");if(this._eventListeners[a.type]instanceof Array){d=this._eventListeners[a.type];g=[];for(f=0,h=d.length;f<h;f++)b=d[f],g.push(b.call(this.target||this,a));return g}};a.addEventListener=
function(e,b,d){if(e.__event==null)e.__event=new a(e);return e.__event.addEventListener(b,d)};a.removeEventListener=function(a,b,d){if(a.__event!=null)return a.__event.removeEventListener(b,d)};a.addDOMEventListener=function(a,b,d){return a.attachEvent!=null?a.attachEvent("on"+b,d):a.addEventListener(b,d,!1)};a.removeDOMEventListener=function(a,b,d){return a.detachEvent!=null?a.detachEvent("on"+b,d):a.removeEventListener(b,d,!1)};a.bind=function(b,c,d){var f,h,g,i,p;f=b instanceof Node||b.toString!=
null&&b.toString()==="[object HTMLBodyElement]"?a.addDOMEventListener:a.addEventListener;c=c.split(" ");p=[];for(g=0,i=c.length;g<i;g++)h=c[g],p.push(f(b,h,d));return p};a.unbind=function(b,c,d){var f,h,g,i,p;f=b instanceof Node?a.removeDOMEventListener:a.removeEventListener;c=c.split(" ");p=[];for(g=0,i=c.length;g<i;g++)h=c[g],p.push(f(b,h,d));return p};a.fire=function(a,b){return a.__event==null?void 0:a.__event.fire(b)};return a}();b={CONTAINER_ELEMENTS:"body,div,center,blockquote,li,td".split(","),
BLOCK_ELEMENTS:"address,dir,dl,form,h1,h2,h3,h4,h5,h6,hr,menu,noframes,ol,p,pre,table,ul,xmp,dt,dd,tr,tbody,thead,tfoot".split(","),CLOSE_ELEMENTS:["img","br","hr"],isNode:function(a){if(a instanceof Node)return!0;else if(b.isHTMLBodyElement(a))return!0;return!1},isHTMLBodyElement:function(a){return(typeof a.toString==="function"?a.toString():void 0)==="[object HTMLBodyElement]"},isContainerNode:function(a){var e,a=(e=a.tagName)!=null?e.toLowerCase():void 0;return a!=null&&l.call(b.CONTAINER_ELEMENTS,
a)>=0},isBlockNode:function(a){var e,a=(e=a.tagName)!=null?e.toLowerCase():void 0;return a!=null&&l.call(b.BLOCK_ELEMENTS,a)>=0},isCloseNode:function(a){var e,a=(e=a.tagName)!=null?e.toLowerCase():void 0;return a!=null&&l.call(b.CLOSE_ELEMENTS,a)>=0},isInlineNode:function(a){return!(b.isContainerNode(a)||b.isBlockNode(a)||b.isDataNode(a))},isDataNode:function(a){return a!=null&&a.nodeType===3},isVisibleNode:function(a){var e,c,d;if(b.isDataNode(a))return a=b.getTextContent(a).replace(/[\s\t\r\n]/g,
""),a.length!==0;else{d=a.childNodes;for(e=0,c=d.length;e<c;e++)if(a=d[e],!b.isVisibleNode(a))return!1;return!0}},isIsolateNode:function(a){return!a.nextSibling&&!a.previousSibling},isAncestorOf:function(a,e){return!b.isDataNode(a)&&(a.contains(b.isDataNode(e)?e.parentNode:e)||e.parentNode===a)},isAncestorOrSelf:function(a,e){return a===e||b.isAncestorOf(a,e)},isEqual:function(a,e){var c,d,f,h;return a!=null&&e!=null&&a.nodeType===e.nodeType?b.isDataNode(a)?b.getTextContent(a)===b.getTextContent(e):
(f=function(a,b){var e,c;if(a instanceof Object&&b instanceof Object)for(e in a){if(c=a[e],f(c,b[e]))return!1}else if(a instanceof Array&&b instanceof Array){if(a.length!==b.length)return!1;for(e=0,c=a.length;0<=c?e<c:e>c;0<=c?e++:e--)if(a[e]!==b[e])return!1}else if(a!==b)return!1;return!0},c=((d=a.tagName)!=null?d.toLowerCase():void 0)===((h=e.tagName)!=null?h.toLowerCase():void 0),d=f(a.styles,e.styles),c&&d):!1},createElementFromHTML:function(a){var b;b=document.createElement("div");b.innerHTML=
a;return b.firstChild},getTextContent:function(a){return a.textContent||a.nodeValue},setTextContent:function(a,b){return a.textContent!=null?a.textContent=b:a.nodeValue=b},getNodeLength:function(a){return b.isDataNode(a)?a.length:a.childNodes.length},findClosestAncestor:function(a,e){if(b.isAncestorOf(a,e))for(;e&&e.parentNode!==a;)e=e.parentNode;return e},findChildPosition:function(a){var b;for(b=0;(a=a.previousSibling)!=null;)b++;return b},findUpstreamNode:function(a,b,c){for(var d;a!=null;){if(d=
b(a))return a;a=a.parentNode;if(c!=null&&c(a))break}return null},findTerminalNode:function(a,b){b==null&&(b=!1);if(b)for(;a!=null&&a.lastChild!=null;)a=a.lastChild;else for(;a!=null&&a.firstChild!=null;)a=a.firstChild;return a},findNextNode:function(a){a=b.findUpstreamNode(a,function(a){return a.nextSibling!=null});return a!=null?a.nextSibling:void 0},findPreviousNode:function(a){a=b.findUpstreamNode(a,function(a){return a.previousSibling!=null});return a!=null?a.previousSibling:void 0},findNextTerminalNode:function(a){a=
b.findNextNode(a);return a=b.findTerminalNode(a)},findPreviousTerminalNode:function(a){a=b.findPreviousNode(a);return a=b.findTerminalNode(a,!0)},applyToAllTerminalNodes:function(a,e,c){var d,f,a=b.findTerminalNode(a),e=b.findTerminalNode(e);for(f=[];a!=null;){d=b.findNextTerminalNode(a);c(a);if(a===e)break;f.push(a=d)}return f},splitDataNode:function(a,e){var c;if(!b.isDataNode(a))return!1;c=a.cloneNode(!1);a.deleteData(e,a.length);c.deleteData(0,e);a.parentNode.insertBefore(c,a.nextSibling);return c},
extractDataNode:function(a,e,c){var d,f,h,g;e==null&&(e=void 0);c==null&&(c=void 0);if(!b.isDataNode(a))return!1;f=b.getTextContent(a);e==null&&(e=0);if(c==null)c=f.length;if(e===c||e===0&&c===f.length)return a;d=f.substring(0,e);e=f.substring(e,c);h=f.substring(c,f.length);c=a.nextSibling;f=a.parentNode;f.removeChild(a);a=document;d.length>0&&(d=a.createTextNode(d),b.isVisibleNode(d)&&f.insertBefore(d,c));e.length>0&&(g=a.createTextNode(e),f.insertBefore(g,c));h.length>0&&(d=a.createTextNode(h),
b.isVisibleNode(d)&&f.insertBefore(d,c));return g},concatDataNode:function(a,e){a.parentNode.removeChild(e);b.setTextContent(a,b.getTextContent(a)+b.getTextContent(e));return a},concatNode:function(a,b){for(b.parentNode.removeChild(b);b.firstChild!=null;)a.appendChild(b.firstChild);return a}};n={_tidyInline:function(a){var e,c,d,f;e={b:"strong",i:"em",u:"ins",s:"del"};for(c in e)if(f=e[c],a.tagName.toLowerCase()===c){a=h.replace(a,document.createElement(f));break}d=a.firstChild;for(e=[];d!=null;)a=
d.nextSibling,b.isContainerNode(d)?(f=function(a){return b.isContainerNode(a)},c=b.findUpstreamNode(d,f),f=d.cloneNode(!1),h.remove(d),h._container(c,f)):b.isBlockNode(d)?(f=function(a){return b.isContainerNode(a)},c=b.findUpstreamNode(d,f),f=d.cloneNode(!1),h.remove(d),h._block(c,f)):b.isInlineNode(d)&&(f=function(a){return b.isEqual(a,d)},c=function(a){return!b.isInlineNode(a)},c=b.findUpstreamNode(d.parentNode,f,c),c!=null&&h.remove(d)),b.isInlineNode(d)&&n._tidyInline(d),e.push(d=a);return e},
_tidyBlock:function(a){var e,c,d,f,g,i,j,p,k,l,m;((g=a.tagName)==="DT"||g==="DD")&&a.parentNode.tagName!=="DL"&&h.out(a,document.createElement("dl"));c=a.firstChild;for(m=[];c!=null;){d=c.nextSibling;if(b.isContainerNode(c))c.tagName==="LI"&&((f=a.tagName)==="OL"||f==="UL")?n._tidyContainer(c):c.tagName==="TD"&&a.tagName==="TR"?n._tidyContainer(c):(g=function(a){return b.isContainerNode(a)},e=b.findUpstreamNode(c,g),g=c.cloneNode(!1),h.remove(c),h._container(e,g));else if(b.isBlockNode(c))if(((i=
c.tagName)==="OL"||i==="UL")&&((j=a.tagName)==="OL"||j==="UL"))n._tidyBlock(c);else if(((p=c.tagName)==="DT"||p==="DD")&&a.tagName==="DL")n._tidyBlock(c);else if(((k=c.tagName)==="TBODY"||k==="THEAD"||k==="TFOOT"||k==="TR")&&a.tagName==="TABLE")n._tidyBlock(c);else if(c.tagName==="TR"&&((l=a.tagName)==="TABLE"||l==="TBODY"||l==="THEAD"||l==="TFOOT"))n._tidyBlock(c);else{g=c;f=a.cloneNode(!1);for(c=g.nextSibling;c!=null;)f.appendChild(c),c=c.nextSibling;i=a.parentNode;c=a.nextSibling;i.insertBefore(g,
c);i.insertBefore(f,c);n._tidyBlock(a);return}else if(d!=null)if(b.isDataNode(c)&&b.isDataNode(d)){c=b.concatDataNode(c,d);continue}else if(b.isInlineNode(c)&&b.isInlineNode(d)&&!b.isCloseNode(c)&&b.isEqual(c,d)){c=b.concatNode(c,d);continue}b.isBlockNode(c)?n._tidyBlock(c):b.isInlineNode(c)&&n._tidyInline(c);m.push(c=d)}return m},_tidyContainer:function(a){var e,c,d,f,g;a.tagName==="LI"&&(e=(c=a.parentNode)!=null?c.tagName:void 0)!=="OL"&&e!=="UL"&&h.out(a,document.createElement("ul"));e=a.firstChild;
for(g=[];e!=null;){d=e.nextSibling;if(b.isContainerNode(e)||b.isBlockNode(e)){if(!b.isDataNode(d)||l.call(b.getTextContent(d),"\n")<0)c=document.createTextNode("\n"),e.parentNode.insertBefore(c,d)}else if((f=a.tagName)!=="LI"&&f!=="TD"&&b.isVisibleNode(e)){e=h.out(e,document.createElement("p"));continue}b.isContainerNode(e)?n._tidyContainer(e):b.isBlockNode(e)&&n._tidyBlock(e);g.push(e=d)}return g},tidy:function(a,b){var c,d,f,h,i,j,k;k=new g(b);h=k.getSelection();if(h.rangeCount>0)f=h.getRangeAt(0),
i=f.startContainer,j=f.startOffset,c=f.endContainer,d=f.endOffset,h.removeAllRanges();n._tidyContainer(a);if(i!=null)try{return f=k.createRange(),f.setStart(i,j),f.setEnd(c,d),k.setSelection(f)}catch(l){}}};g=function(){function a(a){var b;this.document=a;this.window=this.document.defaultView||this.document.parentWindow;if(this.document.createRange==null&&window.IERange!=null)this.document.createRange=k(function(){return new IERange(this.document)},this),b=new IESelection(this.document),this.window.getSelection=
k(function(){this.document.body.focus();return b},this)}a.prototype.getSelection=function(){return this.window.getSelection()};a.prototype.setSelection=function(a){var b;b=this.getSelection();b.removeAllRanges();return b.addRange(a)};a.prototype.getRangeAt=function(a){return this.getSelection().getRangeAt(a)};a.prototype.createRange=function(){return this.document.createRange()};return a}();o=function(){function a(a,b,d,f){this.startContainer=a;this.startOffset=b;this.endContainer=d;this.endOffset=
f}a.prototype.setStart=function(a,b){b==null&&(b=0);this.startContainer=a;return this.startOffset=b};a.prototype.setEnd=function(a,b){var d;if(b==null)a.firstChild!=null?b=a.childNodes.length:(d=a.textContent||a.nodeValue,b=d.length);this.endContainer=a;return this.endOffset=b};a.prototype.attach=function(a){a.setStart(this.startContainer,this.startOffset);a.setEnd(this.endContainer,this.endOffset);return a};return a}();h={out:function(a,b){var c,d,b=b.cloneNode(!1);c=a.nextSibling;d=a.parentNode;
b.appendChild(a);d.insertBefore(b,c);return b},"in":function(a,b){for(b=b.cloneNode(!1);a.firstChild!=null;)b.appendChild(a.firstChild);a.appendChild(b);return a},replace:function(a,b){for(var c,b=b.cloneNode(!1);a.firstChild;)b.appendChild(a.firstChild);c=a.parentNode;c.insertBefore(b,a);c.removeChild(a);return b},remove:function(a){var b,c;b=a.nextSibling;c=a.parentNode;for(c.removeChild(a);a.firstChild;)c.insertBefore(a.firstChild,b);return c},each:function(a,e,c,d,f){d==null&&(d=[]);if(f==null)f=
h.out;return b.applyToAllTerminalNodes(a,e,function(a){if(l.call(d,a)<0&&b.isVisibleNode(a))return f(a,c)})},research:function(a,e,c,d){var f,g,h;d==null&&(d=[]);f=c.tagName.toLowerCase();h=function(a){var b;return((b=a.tagName)!=null?b.toLowerCase():void 0)===f};g=[];b.applyToAllTerminalNodes(a,e,function(a){var e;if(l.call(d,a)<0&&b.isVisibleNode(a))return e=b.findUpstreamNode(a,h),g.push({node:a,found:e})});return g},_container:function(a,e){var c;c=b.findUpstreamNode(a,function(a){return b.isBlockNode(a)&&
b.isContainerNode(a.parentNode)});a=h.out(c,e);c=new o;c.setStart(a);c.setEnd(a);return c},_containerRemove:function(a,e){var c,d,f;d=b.findUpstreamNode(a,function(a){return b.isEqual(a,e)});d!=null?(f=b.findPreviousNode(d),c=b.findNextNode(d),h.remove(d),d=new o,d.setStart(b.findNextNode(f)),d.setEnd(b.findPreviousNode(c))):(d=new o,d.setStart(a),d.setEnd(a));return d},_block:function(a,e,c){var d;c==null&&(c=!0);d=b.findUpstreamNode(a,function(a){return b.isBlockNode(a)});if(d!=null)if(b.isEqual(d,
e))if(c)a=h.replace(d,document.createElement("p"));else return e=b.findPreviousNode(d),a=b.findNextNode(d),h.remove(d),d=new o,d.setStart(b.findNextNode(e)),d.setEnd(b.findPreviousNode(a)),d;else a=h.replace(d,e);else d=b.findUpstreamNode(a,function(a){return b.isContainerNode(a)}),a=h["in"](d,e);d=new o;d.setStart(a);d.setEnd(a);return d},_inline:function(a,e,c,d){var f,g,i,j,k,a=b.findUpstreamNode(a,function(a){return b.isEqual(a,d)});if(a!=null&&d.tagName==="A"&&a.getAttribute("href")!==d.getAttribute("href"))return a.setAttribute("href",
d.getAttribute("href")),i=new o,i.setStart(a),i.setEnd(a),i;if(a!=null){if(g=a.firstChild,i=b.findNextTerminalNode(a.lastChild),a=h.remove(a),f=[],b.applyToAllTerminalNodes(e,c,function(a){return f.push(a)}),h.each(g,i,d,f),e===c&&b.isDataNode(e)&&(a=e.previousSibling,a!=null&&b.isDataNode(a)))return g=e,e=a!=null?a.length:0,c=e+g.length,g=b.concatDataNode(a,g),i=new o,i.setStart(g,e),i.setEnd(g,c),i}else{a=h.research(e,c,d);i=!0;for(j=0,k=a.length;j<k;j++)if(g=a[j],g.found==null){i=!1;break}if(i)for(i=
0,j=a.length;i<j;i++)g=a[i],g.found!=null&&h.remove(g.found);else for(i=0,j=a.length;i<j;i++)g=a[i],g.found==null&&h.out(g.node,d)}i=new o;i.setStart(e);i.setEnd(c);return i},range:function(a,e,c){var d,f,g;c==null&&(c=!1);return b.isContainerNode(e)?c?h._containerRemove(a.commonAncestorContainer,e):h._container(a.commonAncestorContainer,e):b.isBlockNode(e)?h._block(a.commonAncestorContainer,e):(f=a.startContainer,g=a.startOffset,c=a.endContainer,d=a.endOffset,a=a.commonAncestorContainer,f===c&&b.isDataNode(f)?
(f=c=b.extractDataNode(f,g,d),a=f.parentNode):(f=b.isDataNode(f)?b.extractDataNode(f,g):f.childNodes[g],c=b.isDataNode(c)?b.extractDataNode(c,null,d):c.childNodes[d-1]),h._inline(a,f,c,e))}};m=function(){function a(b){this.iframe=b;a.__super__.constructor.call(this,null);this.iframe.attachEvent!=null?i.bind(this.iframe,"onreadystatechange",k(function(){if(this.iframe.readyState==="complete")return i.unbind(this.iframe,"onreadystatechange",arguments.callee),this.fire("ready")},this)):i.bind(this.iframe,
"load",k(function(){return this.fire("ready")},this));this.window=null;this.bind("ready",k(function(){var a;this.window=this.iframe.contentWindow;this.document=this.iframe.contentDocument||this.window.document;this.document.body==null&&this.document.writeln("<body></body>");this.body=this.document.body;this.body.style.cursor="text";this.body.style.height="100%";Richarea.detector.browser==="Explorer"&&Richarea.detector.version<9&&(a=k(function(){return this.body.style.height=""+this.iframe.offsetHeight+
"px"},this),setTimeout(k(function(){var b,e;((b=this.iframe)!=null?b.offsetHeight:void 0)!==((e=this.body)!=null?e.offsetHeight:void 0)&&a();return setTimeout(arguments.callee,100)},this),100));if(this.body.spellcheck!=null)this.body.spellcheck=!1;if(this.body.contentEditable!=null)this.body.contentEditable=!0;else if(this.document.designMode!=null)this.document.designMode="On";i.bind(this.body,"focus click dblclick mousedown mousemove mouseup keydown keypress keyup blur paste",k(function(a){a.target=
this;return this.fire(a)},this));this.bind("focus",k(function(){return this.iframe.setAttribute("previousContent",this.getValue())},this));this.bind("focus click dblclick mousedown mousemove mouseup keydown keyup paste blur",k(function(){return this.update()},this));return this.bind("keydown",k(function(a){return(a.keyCode||a.charCode||a.which)===9&&!a.ctrlKey&&!a.altKey?(a.preventDefault(),a.shiftKey?this.execCommand("outdent"):this.execCommand("indent"),!1):!0},this))},this))}s(a,i);a.prototype.ready=
function(a){return this.window!=null?a({type:"ready",target:this}):this.bind("ready",a)};a.prototype.update=function(){var a;a=this.iframe.getAttribute("previousContent");if(this.getValue()!==a)return this.fire({type:"change",previous:a}),this.iframe.setAttribute("previousContent",this.getValue())};a.prototype.getValue=function(){if(this.window!=null)return this.body.innerHTML};a.prototype.setValue=function(a){if(this.window!=null)return this.body.innerHTML=a,this.update()};a.prototype.execCommand=
function(a,b){b==null&&(b=null);return this.document.execCommand(a,!1,b)};a.prototype.queryCommandState=function(a){return this.document.queryCommandState(a)};a.prototype.queryCommandEnabled=function(a){return this.document.queryCommandEnabled(a)};a.prototype.queryCommandIndeterm=function(a){return this.document.queryCommandIndeterm(a)};a.prototype.queryCommandSupported=function(a){return this.document.queryCommandSupported(a)};a.prototype.queryCommandValue=function(a){return this.document.queryCommandValue(a)};
return a}();this.Richarea=function(){function a(b){this.iframe=b;a.__super__.constructor.call(this,null);if(window.jQuery!=null&&this.iframe instanceof jQuery)this.iframe=this.iframe.get(0);this.raw=new m(this.iframe);this.raw.ready(k(function(){this.selection=new g(this.raw.document);this.raw.bind("focus click dblclick mousedown mousemove mouseup keydown keypress keyup paste blur change",k(function(a){a.target=this;return this.fire(a)},this));this.bind("change",k(function(){return this.tidy()},this));
return this.tidy()},this))}s(a,i);a.detector=new q;a.dom={DOMUtils:b,Surround:h,HTMLTidy:n};a.utils={Event:i};a.prototype.tidy=function(){return n.tidy(this.raw.body,this.raw.document)};a.prototype.ready=function(a){return this.raw.ready(a)};a.prototype.getValue=function(){return this.raw.getValue()};a.prototype.setValue=function(a){return this.raw.setValue(a)};a.prototype.execCommand=function(a,b){b==null&&(b=null);this.raw.execCommand(a,b);return this.raw.update()};a.prototype.applyToAllUpstreamNodeOfSelection=
function(a){var c;c=this.selection.getSelection();if(c.rangeCount>0){c=c.getRangeAt(0);for(c=c.commonAncestorContainer;c!=null&&!b.isHTMLBodyElement(c);)a(c),c=c.parentNode;return!0}else return!1};a.prototype.getUpstreamNodeListOfSelection=function(){var a;a=[];return this.applyToAllUpstreamNodeOfSelection(function(c){if(!b.isDataNode(c))return a.push(c)})?a=a.reverse():[]};a.prototype.getUpstreamNodeTagNameListOfSelection=function(){var a;a=[];return this.applyToAllUpstreamNodeOfSelection(function(c){if(!b.isDataNode(c))return a.push(c.tagName)})?
a=a.reverse():[]};a.prototype.getSelection=function(){return this.selection.getSelection()};a.prototype.setSelection=function(a){return this.selection.setSelection(a)};a.prototype.getSelectedContent=function(){var a;a=this.getSelection();return a.rangeCount>0&&!a.isCollapsed?(a=a.getRangeAt(0),a.cloneContents()):null};a.prototype.replaceSelection=function(a,c){var d,f;c==null&&(c=!0);f=this.getSelection();if(f.rangeCount>0)return a=b.createElementFromHTML(a),d=f.getRangeAt(0),f.removeAllRanges(),
d.extractContents(),d.insertNode(a),d=this.selection.createRange(),d.selectNode(a),c||d.collapse(!1),this.setSelection(d),this.raw.update()};a.prototype.insertBeforeSelection=function(a,c){var d,f;c==null&&(c=!0);d=this.getSelection();if(d.rangeCount>0)return a=b.createElementFromHTML(a),f=d.getRangeAt(0),d.removeAllRanges(),d=f.extractContents(),f.insertNode(d),f.insertNode(a),f=this.selection.createRange(),f.setStartBefore(d,0),f.setEndAfter(a,b.getNodeLength(a)),c||f.collapse(!1),this.setSelection(f),
this.raw.update()};a.prototype.insertAfterSelection=function(a,c){var d,f;c==null&&(c=!0);d=this.getSelection();if(d.rangeCount>0)return a=b.createElementFromHTML(a),f=d.getRangeAt(0),d.removeAllRanges(),d=f.extractContents(),f.insertNode(a),f.insertNode(d),f=this.selection.createRange(),f.setStart(a,0),f.setEnd(d,b.getNodeLength(d)),c||f.collapse(!1),this.setSelection(f),this.raw.update()};a.prototype.surroundSelection=function(a,c){var d,f;c==null&&(c=!0);d=this.getSelection();if(d.rangeCount>0)return a=
b.createElementFromHTML(a),f=d.getRangeAt(0),d.removeAllRanges(),d=h.range(f,a),f=this.selection.createRange(),f=d.attach(f),c||f.collapse(!1),this.setSelection(f),this.raw.update()};a.prototype.unsurroundSelection=function(a,c){var d,f;c==null&&(c=!0);d=this.getSelection();if(d.rangeCount>0)return a=b.createElementFromHTML(a),f=d.getRangeAt(0),d.removeAllRanges(),d=h.range(f,a,!0),f=this.selection.createRange(),f=d.attach(f),c||f.collapse(!1),this.setSelection(f),this.raw.update()};return a}()}).call(this);
