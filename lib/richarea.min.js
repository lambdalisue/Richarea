/*!
 * Richarea - A JavaScript contentEditable munipulator library v0.2.0
 * http://github.com/lambdalisue/Richarea
 * 
 * Copyright 2011 (c) hashnote.net, Alisue allright reserved.
 * Licensed under the MIT license.
 * 
 * Last-Modified: Mon, 07 Nov 2011 07:52:35 GMT
 */
(function(){function d(c){this._document=c;this.startContainer=this.endContainer=c.body;this.endOffset=h.getNodeLength(c.body)}function r(c){this.range=c;if(!c.collapsed){var b=c.commonAncestorContainer;this._next=c.startContainer==b&&!h.isDataNode(c.startContainer)?c.startContainer.childNodes[c.startOffset]:h.findClosestAncestor(b,c.startContainer);this._end=c.endContainer==b&&!h.isDataNode(c.endContainer)?c.endContainer.childNodes[c.endOffset]:h.findClosestAncestor(b,c.endContainer).nextSibling}}
function b(c){this._document=c;var b=this;c.attachEvent("onselectionchange",function(){b._selectionChangeHandler()})}var h={findChildPosition:function(c){for(var b=0;c=c.previousSibling;b++);return b},isDataNode:function(c){return c&&c.nodeValue!==null&&c.data!==null},isAncestorOf:function(c,b){return!h.isDataNode(c)&&(c.contains(h.isDataNode(b)?b.parentNode:b)||b.parentNode==c)},isAncestorOrSelf:function(c,b){return h.isAncestorOf(c,b)||c==b},findClosestAncestor:function(c,b){if(h.isAncestorOf(c,
b))for(;b&&b.parentNode!=c;)b=b.parentNode;return b},getNodeLength:function(c){return h.isDataNode(c)?c.length:c.childNodes.length},splitDataNode:function(c,b){if(!h.isDataNode(c))return false;var i=c.cloneNode(false);c.deleteData(b,c.length);i.deleteData(0,b);c.parentNode.insertBefore(i,c.nextSibling)}},k={convertToDOMRange:function(c,b){function i(c,i,n){var h=b.createElement("a"),a=i.duplicate();a.collapse(n);var e=a.parentElement();do e.insertBefore(h,h.previousSibling),a.moveToElementText(h);
while(a.compareEndPoints(n?"StartToStart":"StartToEnd",i)>0&&h.previousSibling);if(a.compareEndPoints(n?"StartToStart":"StartToEnd",i)==-1&&h.nextSibling)a.setEndPoint(n?"EndToStart":"EndToEnd",i),c[n?"setStart":"setEnd"](h.nextSibling,a.text.length);else c[n?"setStartBefore":"setEndBefore"](h);h.parentNode.removeChild(h)}var n=new d(b);i(n,c,true);i(n,c,false);return n},convertFromDOMRange:function(c){function b(c,i,p){var d=i[p?"startContainer":"endContainer"],k=i[p?"startOffset":"endOffset"],a=
0,e=h.isDataNode(d)?d:k===d.childNodes.length?null:d.childNodes[k],f=h.isDataNode(d)?d.parentNode:d;if(d.nodeType==3||d.nodeType==4)a=k;d=i._document.createElement("a");f.insertBefore(d,e);i=i._document.body.createTextRange();i.moveToElementText(d);d.parentNode.removeChild(d);c.setEndPoint(p?"StartToStart":"EndToStart",i);c[p?"moveStart":"moveEnd"]("character",a)}var i=c._document.body.createTextRange();b(i,c,true);b(i,c,false);return i}};d.START_TO_START=0;d.START_TO_END=1;d.END_TO_END=2;d.END_TO_START=
3;d.prototype={startContainer:null,startOffset:0,endContainer:null,endOffset:0,commonAncestorContainer:null,collapsed:false,_document:null,_refreshProperties:function(){this.collapsed=this.startContainer==this.endContainer&&this.startOffset==this.endOffset;for(var c=this.startContainer;c&&c!=this.endContainer&&!h.isAncestorOf(c,this.endContainer);)c=c.parentNode;this.commonAncestorContainer=c},setStart:function(c,b){this.startContainer=c;this.startOffset=b;this._refreshProperties()},setEnd:function(c,
b){this.endContainer=c;this.endOffset=b;this._refreshProperties()},setStartBefore:function(c){this.setStart(c.parentNode,h.findChildPosition(c))},setStartAfter:function(c){this.setStart(c.parentNode,h.findChildPosition(c)+1)},setEndBefore:function(c){this.setEnd(c.parentNode,h.findChildPosition(c))},setEndAfter:function(c){this.setEnd(c.parentNode,h.findChildPosition(c)+1)},selectNode:function(c){this.setStartBefore(c);this.setEndAfter(c)},selectNodeContents:function(c){this.setStart(c,0);this.setEnd(c,
h.getNodeLength(c))},collapse:function(c){c?this.setEnd(this.startContainer,this.startOffset):this.setStart(this.endContainer,this.endOffset)},cloneContents:function(){return function p(b){for(var d,h=document.createDocumentFragment();d=b.next();)d=d.cloneNode(!b.hasPartialSubtree()),b.hasPartialSubtree()&&d.appendChild(p(b.getSubtreeIterator())),h.appendChild(d);return h}(new r(this))},extractContents:function(){var c=this.cloneRange();this.startContainer!=this.commonAncestorContainer&&this.setStartAfter(h.findClosestAncestor(this.commonAncestorContainer,
this.startContainer));this.collapse(true);return function i(c){for(var b,d=document.createDocumentFragment();b=c.next();)c.hasPartialSubtree()?b=b.cloneNode(false):c.remove(),c.hasPartialSubtree()&&b.appendChild(i(c.getSubtreeIterator())),d.appendChild(b);return d}(new r(c))},deleteContents:function(){var c=this.cloneRange();this.startContainer!=this.commonAncestorContainer&&this.setStartAfter(h.findClosestAncestor(this.commonAncestorContainer,this.startContainer));this.collapse(true);(function i(c){for(;c.next();)c.hasPartialSubtree()?
i(c.getSubtreeIterator()):c.remove()})(new r(c))},insertNode:function(c){h.isDataNode(this.startContainer)?(h.splitDataNode(this.startContainer,this.startOffset),this.startContainer.parentNode.insertBefore(c,this.startContainer.nextSibling)):this.startContainer.insertBefore(c,this.startContainer.childNodes[this.startOffset]);this.setStart(this.startContainer,this.startOffset)},surroundContents:function(c){var b=this.extractContents();this.insertNode(c);console.log(this);c.appendChild(b);this.selectNode(c)},
compareBoundaryPoints:function(c,b){var i,h,k,l;switch(c){case d.START_TO_START:case d.START_TO_END:i=this.startContainer;h=this.startOffset;break;case d.END_TO_END:case d.END_TO_START:i=this.endContainer,h=this.endOffset}switch(c){case d.START_TO_START:case d.END_TO_START:k=b.startContainer;l=b.startOffset;break;case d.START_TO_END:case d.END_TO_END:k=b.endContainer,l=b.endOffset}return i.sourceIndex<k.sourceIndex?-1:i.sourceIndex==k.sourceIndex?h<l?-1:h==l?0:1:1},cloneRange:function(){var c=new d(this._document);
c.setStart(this.startContainer,this.startOffset);c.setEnd(this.endContainer,this.endOffset);return c},detach:function(){},toString:function(){return k.convertFromDOMRange(this).text},createContextualFragment:function(c){var b=(h.isDataNode(this.startContainer)?this.startContainer.parentNode:this.startContainer).cloneNode(false);b.innerHTML=c;for(c=this._document.createDocumentFragment();b.firstChild;)c.appendChild(b.firstChild);return c}};r.prototype={range:null,_current:null,_next:null,_end:null,
hasNext:function(){return!!this._next},next:function(){var b=this._current=this._next;this._next=this._current&&this._current.nextSibling!=this._end?this._current.nextSibling:null;h.isDataNode(this._current)&&(this.range.endContainer==this._current&&(b=b.cloneNode(true)).deleteData(this.range.endOffset,b.length-this.range.endOffset),this.range.startContainer==this._current&&(b=b.cloneNode(true)).deleteData(0,this.range.startOffset));return b},remove:function(){if(h.isDataNode(this._current)&&(this.range.startContainer==
this._current||this.range.endContainer==this._current)){var b=this.range.startContainer==this._current?this.range.startOffset:0;this._current.deleteData(b,(this.range.endContainer==this._current?this.range.endOffset:this._current.length)-b)}else this._current.parentNode.removeChild(this._current)},hasPartialSubtree:function(){return!h.isDataNode(this._current)&&(h.isAncestorOrSelf(this._current,this.range.startContainer)||h.isAncestorOrSelf(this._current,this.range.endContainer))},getSubtreeIterator:function(){var b=
new d(this.range._document);b.selectNodeContents(this._current);h.isAncestorOrSelf(this._current,this.range.startContainer)&&b.setStart(this.range.startContainer,this.range.startOffset);h.isAncestorOrSelf(this._current,this.range.endContainer)&&b.setEnd(this.range.endContainer,this.range.endOffset);return new r(b)}};b.prototype={rangeCount:0,_document:null,_selectionChangeHandler:function(){this.rangeCount=this._selectionExists(this._document.selection.createRange())?1:0},_selectionExists:function(b,
d){d===void 0&&(d=true);return b.compareEndPoints("StartToEnd",b)!=0||b.parentElement().isContentEditable&&d},addRange:function(b){var d=this._document.selection.createRange(),b=k.convertFromDOMRange(b);this._selectionExists(d,false)?(b.compareEndPoints("StartToStart",d)==-1&&(b.compareEndPoints("StartToEnd",d)>-1&&b.compareEndPoints("EndToEnd",d)==-1?d.setEndPoint("StartToStart",b):b.compareEndPoints("EndToStart",d)<1&&b.compareEndPoints("EndToEnd",d)>-1&&d.setEndPoint("EndToEnd",b)),d.select()):
b.select()},removeAllRanges:function(){this._document.selection.empty()},getRangeAt:function(){var b=this._document.selection.createRange();return this._selectionExists(b)?k.convertToDOMRange(b,this._document):null},toString:function(){return this._document.selection.createRange().text}};if(window.getSelection===void 0){document.createRange=function(){return new d(document)};var q=new b(document);window.getSelection=function(){return q};window.DOMRange=d;window.DOMSelection=b}})();
(function(){var d,r,b,h,k,q,c,p,i,n,s=Array.prototype.indexOf||function(a){for(var e=0,f=this.length;e<f;e++)if(this[e]===a)return e;return-1},l=function(a,e){return function(){return a.apply(e,arguments)}},u=Object.prototype.hasOwnProperty,t=function(a,e){function f(){this.constructor=a}for(var b in e)u.call(e,b)&&(a[b]=e[b]);f.prototype=e.prototype;a.prototype=new f;a.__super__=e.prototype;return a};h=function(){function a(){this.browser=this.searchString(a.dataBrowser)||"An unknown browser";this.version=
this.searchVersion(navigator.userAgent)||this.searchVersion(navigator.appVersion)||"An unknown browser";this.OS=this.searchString(a.dataOS)||"An unknown OS"}a.prototype.searchString=function(a){var f,b,c;for(b=0,c=a.length;b<c;b++)if(f=a[b],this.versionSearchString=f.versionSearch||f.identify,f.string!=null)if(f.string.indexOf(f.subString)!==-1)return f.identify;else if(f.prop)return f.identify;return[]};a.prototype.searchVersion=function(a){var b;b=a.indexOf(this.versionSearchString);return b===
-1?void 0:parseFloat(a.substring(b+this.versionSearchString.length+1))};a.dataBrowser=[{string:navigator.userAgent,subString:"Chrome",identify:"Chrome"},{string:navigator.userAgent,subString:"OmniWeb",versionSearch:"OmniWeb/",identify:"OmniWeb"},{string:navigator.vendor,subString:"Apple",identify:"Safari",versionSearch:"Version"},{prop:window.opera,identify:"Opera",versionSearch:"Version"},{string:navigator.vendor,subString:"iCab",identify:"iCab"},{string:navigator.vendor,subString:"KDE",identify:"Konqueror"},
{string:navigator.userAgent,subString:"Firefox",identify:"Firefox"},{string:navigator.vendor,subString:"Camino",identify:"Camino"},{string:navigator.userAgent,subString:"Netscape",identify:"Netscape"},{string:navigator.userAgent,subString:"MSIE",identify:"Explorer",versionSearch:"MSIE"},{string:navigator.userAgent,subString:"Gecko",identify:"Mozilla",versionSearch:"rv"},{string:navigator.userAgent,subString:"Mozilla",identify:"Netscape",versionSearch:"Mozilla"}];a.dataOS=[{string:navigator.platform,
subString:"Win",identify:"Windows"},{string:navigator.platform,subString:"Mac",identify:"Mac"},{string:navigator.userAgent,subString:"iPhone",identify:"iPhone/iPad"},{string:navigator.platform,subString:"Linux",identify:"Linux"}];return a}();if(typeof exports!=="undefined"&&exports!==null)exports.Detector=h;n=function(a,e){var b,g;for(g in e)b=e[g],a.prototype[g]=b;return a};if(typeof exports!=="undefined"&&exports!==null)exports.partial=n;k=function(){function a(a){this.target=a;this._eventListeners=
{}}a.prototype.addEventListener=function(a,b){this._eventListeners[a]==null&&(this._eventListeners[a]=[]);return this._eventListeners[a].push(b)};a.prototype.removeEventListener=function(a,b){var g,c,o,j,d;if(this._eventListeners[a]instanceof Array){c=this._eventListeners[a];d=[];for(g=0,o=c.length;g<o;g++)if(j=c[g],j===b){c.splice(g,1);break}return d}};a.prototype.bind=function(a,b){var g,c,o,j,a=a.split(" ");j=[];for(c=0,o=a.length;c<o;c++)g=a[c],j.push(this.addEventListener(g,b));return j};a.prototype.unbind=
function(a,b){var g,c,o,j,a=a.split(" ");j=[];for(c=0,o=a.length;c<o;c++)g=a[c],j.push(this.removeEventListener(g,b));return j};a.prototype.fire=function(a){var b,g,c,o,j;typeof a==="string"&&(a={type:a});if(a.target==null)a.target=this.target||this;if(a.type==null)throw Error("Event objet missing `type` property");if(this._eventListeners[a.type]instanceof Array){g=this._eventListeners[a.type];j=[];for(c=0,o=g.length;c<o;c++)b=g[c],j.push(b.call(this.target||this,a));return j}};a.addEventListener=
function(e,b,g){if(e.__event==null)e.__event=new a(e);return e.__event.addEventListener(b,g)};a.removeEventListener=function(a,b,g){if(a.__event!=null)return a.__event.removeEventListener(b,g)};a.addDOMEventListener=function(a,b,g){return a.attachEvent!=null?a.attachEvent("on"+b,g):a.addEventListener(b,g,false)};a.removeDOMEventListener=function(a,b,g){return a.detachEvent!=null?a.detachEvent("on"+b,g):a.removeEventListener(b,g,false)};a.bind=function(b,f,g){var c,o,j,d,i;c=b instanceof Node||b.toString!=
null&&b.toString()==="[object HTMLBodyElement]"?a.addDOMEventListener:a.addEventListener;f=f.split(" ");i=[];for(j=0,d=f.length;j<d;j++)o=f[j],i.push(c(b,o,g));return i};a.unbind=function(b,f,g){var c,d,j,i,h;c=b instanceof Node?a.removeDOMEventListener:a.removeEventListener;f=f.split(" ");h=[];for(j=0,i=f.length;j<i;j++)d=f[j],h.push(c(b,d,g));return h};a.fire=function(a,b){return a.__event==null?void 0:a.__event.fire(b)};return a}();b={CONTAINER_ELEMENTS:"body,div,center,blockquote,li,td".split(","),
BLOCK_ELEMENTS:"address,dir,dl,form,h1,h2,h3,h4,h5,h6,hr,menu,noframes,ol,p,pre,table,ul,xmp".split(","),CLOSE_ELEMENTS:["img","br","hr"],isContainerNode:function(a){var e,a=(e=a.tagName)!=null?e.toLowerCase():void 0;return a!=null&&s.call(b.CONTAINER_ELEMENTS,a)>=0},isBlockNode:function(a){var e,a=(e=a.tagName)!=null?e.toLowerCase():void 0;return a!=null&&s.call(b.BLOCK_ELEMENTS,a)>=0},isCloseNode:function(a){var e,a=(e=a.tagName)!=null?e.toLowerCase():void 0;return a!=null&&s.call(b.CLOSE_ELEMENTS,
a)>=0},isInlineNode:function(a){return!(b.isContainerNode(a)||b.isBlockNode(a)||b.isDataNode(a))},isDataNode:function(a){return a!=null&&a.nodeType===3},isVisibleNode:function(a){var e,f,c;if(b.isDataNode(a))return a=b.getTextContent(a).replace(/[\s\t\r\n]/g,""),a.length!==0;else{c=a.childNodes;for(e=0,f=c.length;e<f;e++)if(a=c[e],!b.isVisibleNode(a))return false;return true}},isIsolateNode:function(a){return!a.nextSibling&&!a.previousSibling},isAncestorOf:function(a,e){return!b.isDataNode(a)&&(a.contains(b.isDataNode(e)?
e.parentNode:e)||e.parentNode===a)},isAncestorOrSelf:function(a,e){return a===e||b.isAncestorOf(a,e)},isEqual:function(a,e){var f,c,m,d;return a!=null&&e!=null&&a.nodeType===e.nodeType?b.isDataNode(a)?b.getTextContent(a)===b.getTextContent(e):(m=function(a,b){var e,f;if(a instanceof Object&&b instanceof Object)for(e in a){if(f=a[e],m(f,b[e]))return false}else if(a instanceof Array&&b instanceof Array){if(a.length!==b.length)return false;for(e=0,f=a.length;0<=f?e<f:e>f;0<=f?e++:e--)if(a[e]!==b[e])return false}else if(a!==
b)return false;return true},f=((c=a.tagName)!=null?c.toLowerCase():void 0)===((d=e.tagName)!=null?d.toLowerCase():void 0),c=m(a.styles,e.styles),f&&c):false},createElementFromHTML:function(a){var b;b=document.createElement("div");b.innerHTML=a;return b.firstChild},getTextContent:function(a){return a.textContent||a.nodeValue},setTextContent:function(a,b){return a.textContent!=null?a.textContent=b:a.nodeValue=b},getNodeLength:function(a){return b.isDataNode(a)?a.length:a.childNodes.length},findClosestAncestor:function(a,
e){if(b.isAncestorOf(a,e))for(;e&&e.parentNode!==a;)e=e.parentNode;return e},findChildPosition:function(a){var b;for(b=0;(a=a.previousSibling)!=null;)b++;return b},findUpstreamNode:function(a,b,f){for(var c;a!=null;){if(c=b(a))return a;a=a.parentNode;if(f!=null&&f(node))break}return null},findTerminalNode:function(a,b){b==null&&(b=false);if(b)for(;a!=null&&a.lastChild!=null;)a=a.lastChild;else for(;a!=null&&a.firstChild!=null;)a=a.firstChild;return a},findNextNode:function(a){a=b.findUpstreamNode(a,
function(a){return a.nextSibling!=null});return a!=null?a.nextSibling:void 0},findPreviousNode:function(a){a=b.findUpstreamNode(a,function(a){return a.previousSibling!=null});return a!=null?a.previousSibling:void 0},findNextTerminalNode:function(a){a=b.findNextNode(a);return a=b.findTerminalNode(a)},findPreviousTerminalNode:function(a){a=b.findPreviousNode(a);return a=b.findTerminalNode(a,true)},applyToAllTerminalNodes:function(a,e,f){var c,m,a=b.findTerminalNode(a),e=b.findTerminalNode(e);for(m=
[];a!=null;){c=b.findNextTerminalNode(a);f(a);if(a===e)break;m.push(a=c)}return m},splitDataNode:function(a,e){var f;if(!b.isDataNode(a))return false;f=a.cloneNode(false);a.deleteData(e,a.length);f.deleteData(0,e);a.parentNode.insertBefore(f,a.nextSibling);return f},extractDataNode:function(a,e,f){var c,m,d,i;e==null&&(e=void 0);f==null&&(f=void 0);if(!b.isDataNode(a))return false;m=b.getTextContent(a);e==null&&(e=0);if(f==null)f=m.length;if(e===f||e===0&&f===m.length)return a;c=m.substring(0,e);
e=m.substring(e,f);d=m.substring(f,m.length);f=a.nextSibling;m=a.parentNode;m.removeChild(a);a=document;c.length>0&&(c=a.createTextNode(c),b.isVisibleNode(c)&&m.insertBefore(c,f));e.length>0&&(i=a.createTextNode(e),m.insertBefore(i,f));d.length>0&&(c=a.createTextNode(d),b.isVisibleNode(c)&&m.insertBefore(c,f));return i},concatDataNode:function(a,e){a.parentNode.removeChild(e);b.setTextContent(a,b.getTextContent(a)+b.getTextContent(e));return a},concatNode:function(a,b){for(b.parentNode.removeChild(b);b.firstChild!=
null;)a.appendChild(b.firstChild);return a}};q={_tidyInline:function(a){var e,f,c,d;f=a.firstChild;for(d=[];f!=null;)a=f.nextSibling,b.isContainerNode(f)?(c=function(a){return b.isContainerNode(a)},e=b.findUpstreamNode(f,c),c=f.cloneNode(false),i.remove(f),i._container(e,c)):b.isBlockNode(f)?(c=function(a){return b.isContainerNode(a)},e=b.findUpstreamNode(f,c),c=f.cloneNode(false),i.remove(f),i._block(e,c)):b.isInlineNode(f)&&(c=function(a){return b.isEqual(a,f)},e=function(a){return!b.isInlineNode(a)},
e=b.findUpstreamNode(f,c,e),e!=null&&i.remove(f)),b.isInlineNode(f)&&q._tidyInline(f),d.push(f=a);return d},_tidyBlock:function(a){var e,c,g,d,a=a.firstChild;for(d=[];a!=null;){c=a.nextSibling;if(b.isContainerNode(a))e=function(a){return b.isContainerNode(a)},e=b.findUpstreamNode(a,e),g=a.cloneNode(false),i.remove(a),i._container(e,g);else if(b.isBlockNode(a))e=function(a){return b.isContainerNode(a)},e=b.findUpstreamNode(a,e),g=a.cloneNode(false),i.remove(a),i._block(e,g);else if(c!=null)if(b.isDataNode(a)&&
b.isDataNode(c)){a=b.concatDataNode(a,c);continue}else if(b.isInlineNode(a)&&b.isInlineNode(c)&&!b.isCloseNode(a)&&b.isEqual(a,c)){a=b.concatNode(a,c);continue}b.isBlockNode(a)?q._tidyBlock(a):b.isInlineNode(a)&&q._tidyInline(a);d.push(a=c)}return d},_tidyContainer:function(a){var e,c,g,a=a.firstChild;for(g=[];a!=null;){c=a.nextSibling;if(b.isContainerNode(a)||b.isBlockNode(a)){if(!b.isDataNode(c)||s.call(b.getTextContent(c),"\n")<0)e=document.createTextNode("\n"),a.parentNode.insertBefore(e,c)}else if(b.isVisibleNode(a)){a=
i.out(a,document.createElement("p"));continue}b.isContainerNode(a)?q._tidyContainer(a):b.isBlockNode(a)&&q._tidyBlock(a);g.push(a=c)}return g},tidy:function(a,b){var c,g,d,i,j,h,k;k=new p(b);i=k.getSelection();if(i.rangeCount>0)d=i.getRangeAt(0),j=d.startContainer,h=d.startOffset,c=d.endContainer,g=d.endOffset,i.removeAllRanges();q._tidyContainer(a);if(j!=null)return d=k.createRange(),d.setStart(j,h),d.setEnd(c,g),k.setSelection(d)}};p=function(){function a(a){var b;this.document=a;this.window=this.document.defaultView||
this.document.parentWindow;if(this.document.createRange==null&&window.IERange!=null)this.document.createRange=l(function(){return new IERange(this.document)},this),b=new IESelection(this.document),this.window.getSelection=l(function(){this.document.body.focus();return b},this)}a.prototype.getSelection=function(){return this.window.getSelection()};a.prototype.setSelection=function(a){var b;b=this.getSelection();b.removeAllRanges();return b.addRange(a)};a.prototype.getRangeAt=function(a){return this.getSelection().getRangeAt(a)};
a.prototype.createRange=function(){return this.document.createRange()};return a}();c=function(){function a(a,b,c,d){this.startContainer=a;this.startOffset=b;this.endContainer=c;this.endOffset=d}a.prototype.setStart=function(a,b){b==null&&(b=0);this.startContainer=a;return this.startOffset=b};a.prototype.setEnd=function(a,b){var c;if(b==null)a.firstChild!=null?b=a.childNodes.length:(c=a.textContent||a.nodeValue,b=c.length);this.endContainer=a;return this.endOffset=b};a.prototype.attach=function(a){a.setStart(this.startContainer,
this.startOffset);a.setEnd(this.endContainer,this.endOffset);return a};return a}();i={out:function(a,b){var c,g,b=b.cloneNode(false);c=a.nextSibling;g=a.parentNode;b.appendChild(a);g.insertBefore(b,c);return b},"in":function(a,b){for(b=b.cloneNode(false);a.firstChild!=null;)b.appendChild(a.firstChild);a.appendChild(b);return a},replace:function(a,b){for(var c,b=b.cloneNode(false);a.firstChild;)b.appendChild(a.firstChild);c=a.parentNode;c.insertBefore(b,a);c.removeChild(a);return b},remove:function(a){var b,
c;b=a.nextSibling;c=a.parentNode;for(c.removeChild(a);a.firstChild;)c.insertBefore(a.firstChild,b);return c},each:function(a,c,f,g,d){g==null&&(g=[]);if(d==null)d=i.out;return b.applyToAllTerminalNodes(a,c,function(a){if(s.call(g,a)<0&&b.isVisibleNode(a))return d(a,f)})},research:function(a,c,f,g){var d,i,j;g==null&&(g=[]);d=f.tagName.toLowerCase();j=function(a){var b;return((b=a.tagName)!=null?b.toLowerCase():void 0)===d};i=[];b.applyToAllTerminalNodes(a,c,function(a){var c;if(s.call(g,a)<0&&b.isVisibleNode(a))return c=
b.findUpstreamNode(a,j),i.push({node:a,found:c})});return i},_container:function(a,e){var f;f=b.findUpstreamNode(a,function(a){return b.isBlockNode(a)&&b.isContainerNode(a.parentNode)});a=i.out(f,e);f=new c;f.setStart(a);f.setEnd(a);return f},_containerRemove:function(a,e){var f,g,d;g=b.findUpstreamNode(a,function(a){return b.isEqual(a,e)});g!=null?(d=b.findPreviousNode(g),f=b.findNextNode(g),i.remove(g),g=new c,g.setStart(b.findNextNode(d)),g.setEnd(b.findPreviousNode(f))):(g=new c,g.setStart(a),
g.setEnd(a));return g},_block:function(a,e,f){var g;f==null&&(f=true);g=b.findUpstreamNode(a,function(a){return b.isBlockNode(a)});if(g!=null)if(b.isEqual(g,e))if(f)a=i.replace(g,document.createElement("p"));else return e=b.findPreviousNode(g),a=b.findNextNode(g),i.remove(g),g=new c,g.setStart(b.findNextNode(e)),g.setEnd(b.findPreviousNode(a)),g;else a=i.replace(g,e);else g=b.findUpstreamNode(a,function(a){return b.isContainerNode(a)}),a=i["in"](g,e);g=new c;g.setStart(a);g.setEnd(a);return g},_inline:function(a,
e,f,g){var d,h,j,k,l,a=b.findUpstreamNode(a,function(a){return b.isEqual(a,g)});if(a!=null){if(h=a.firstChild,j=a.lastChild,a=i.remove(a),d=[],b.applyToAllTerminalNodes(e,f,function(a){return d.push(a)}),i.each(h,j,g,d),e===f&&b.isDataNode(e)&&(j=e.previousSibling,j!=null&&b.isDataNode(j)))return h=e,e=j!=null?j.length:0,f=e+h.length,h=b.concatDataNode(j,h),j=new c,j.setStart(h,e),j.setEnd(h,f),j}else{j=i.research(e,f,g);a=true;for(k=0,l=j.length;k<l;k++)if(h=j[k],h.found==null){a=false;break}if(a)for(a=
0,k=j.length;a<k;a++)h=j[a],h.found!=null&&i.remove(h.found);else for(a=0,k=j.length;a<k;a++)h=j[a],h.found==null&&i.out(h.node,g)}j=new c;j.setStart(e);j.setEnd(f);return j},range:function(a,c,f){var g,d,h;f==null&&(f=false);return b.isContainerNode(c)?f?i._containerRemove(a.commonAncestorContainer,c):i._container(a.commonAncestorContainer,c):b.isBlockNode(c)?i._block(a.commonAncestorContainer,c):(d=a.startContainer,h=a.startOffset,f=a.endContainer,g=a.endOffset,a=a.commonAncestorContainer,d===f&&
b.isDataNode(d)?(d=f=b.extractDataNode(d,h,g),a=d.parentNode):(d=b.isDataNode(d)?b.extractDataNode(d,h):d.childNodes[h],f=b.isDataNode(f)?b.extractDataNode(f,null,g):f.childNodes[g-1]),i._inline(a,d,f,c))}};d=function(){function a(a){this.richarea=a;this.richarea.ready(l(function(){return this.selection=new p(this.richarea.raw.document)},this))}a.prototype.execCommand=function(a,c){var d,h;d=this.selection.getSelection();h=d.getRangeAt(0);d.removeAllRanges();switch(a){case "surround":d=b.createElementFromHTML(c);
d=i.range(h,d);h=this.selection.createRange();h=d.attach(h);break;case "unsurround":d=b.createElementFromHTML(c),d=i.range(h,d,true),h=this.selection.createRange(),h=d.attach(h)}this.selection.setSelection(h);return true};return a}();if(typeof require!=="undefined"&&require!==null)n=require("../utils/partial").partial,d=require("./api.core").API;d=n(d,{indent:function(){return this.raw.execCommand("indent")},outdent:function(){return this.raw.execCommand("outdent")}});if(typeof exports!=="undefined"&&
exports!==null)exports.API=d;d=n(d,{blockquote:function(){return this.execCommand("surround","<blockquote>")},unblockquote:function(){return this.execCommand("unsurround","<blockquote>")},heading:function(a){return this.execCommand("surround","<h"+a+">")},h1:function(){return this.heading(1)},h2:function(){return this.heading(2)},h3:function(){return this.heading(3)},h4:function(){return this.heading(4)},h5:function(){return this.heading(5)},h6:function(){return this.heading(6)},p:function(){return this.execCommand("surround",
"<p>")},pre:function(){return this.execCommand("surround","<pre>")}});d=n(d,{strong:function(){return this.execCommand("surround","<strong>")},em:function(){return this.execCommand("surround","<em>")},ins:function(){return this.execCommand("surround","<ins>")},del:function(){return this.execCommand("surround","<del>")},sub:function(){return this.execCommand("surround","<sub>")},sup:function(){return this.execCommand("surround","<sup>")}});d=n(d,{a:function(a){return this.execCommand("surround","<a href='"+
a+"'>")},img:function(a){return this.execCommand("insert","<img src='"+a+"'>")},ul:function(){return this.raw.execCommand("insertUnorderedList")},ol:function(){return this.raw.execCommand("insertOrderedList")},hr:function(){return this.raw.execCommand("insertHorizontalRule")},table:function(a){var b,c,d,h,i;a==null&&(a=[5,5,"Table Caption"]);d=a[0];b=a[1];a=a[2];h=function(){var a;a=[];for(c=0;0<=b?c<b:c>b;0<=b?c++:c--)a.push("    <td>XXX</td>");return a}();i=function(){var a;a=[];for(c=0;0<=d?c<
d:c>d;0<=d?c++:c--)a.push("  <tr>\n"+h.join("\n")+"\n  </tr>");return a}();return this.execCommand("insert","<table>"+(a!=null?"\n<caption>"+a+"</caption>":"")+"\n"+i.join("\n")+"\n</table>")}});d=n(d,{forecolor:function(a){return this.execCommand("style",{color:a})},backcolor:function(a){return this.execCommand("style",{backgroundColor:a})},fontfamily:function(a){return this.execCommand("style",{fontFamily:a})},fontsize:function(a){return this.execCommand("style",{fontSize:a})},justifyleft:function(){return this.execCommand("style",
{textAlign:"left"},true)},justifycenter:function(){return this.execCommand("style",{textAlign:"center"},true)},justifyright:function(){return this.execCommand("style",{textAlign:"right"},true)},justifyfull:function(){return this.execCommand("style",{textAlign:"justify"},true)}});r=function(){function a(b){this.iframe=b;a.__super__.constructor.call(this,null);this.iframe.attachEvent!=null?k.bind(this.iframe,"onreadystatechange",l(function(){if(this.iframe.readyState==="complete")return k.unbind(this.iframe,
"onreadystatechange",arguments.callee),this.fire("ready")},this)):k.bind(this.iframe,"load",l(function(){return this.fire("ready")},this));this.bind("ready",l(function(){var a;this.window=this.iframe.contentWindow;this.document=this.iframe.contentDocument||this.window.document;this.document.body==null&&this.document.writeln("<body></body>");this.body=this.document.body;this.body.style.cursor="text";this.body.style.height="100%";Richarea.detector.browser==="Explorer"&&Richarea.detector.version<9&&
(a=l(function(){return this.body.style.height=""+this.iframe.offsetHeight+"px"},this),setTimeout(l(function(){var b,c;((b=this.iframe)!=null?b.offsetHeight:void 0)!==((c=this.body)!=null?c.offsetHeight:void 0)&&a();return setTimeout(arguments.callee,100)},this),100));if(this.body.spellcheck!=null)this.body.spellcheck=false;if(this.body.contentEditable!=null)this.body.contentEditable=true;else if(this.document.designMode!=null)this.document.designMode="On";k.bind(this.body,"focus click dblclick keydown keypress keyup blur paste",
l(function(a){a.target=this;return this.fire(a)},this));this.bind("focus",l(function(){return this.iframe.setAttribute("previousContent",this.getValue())},this));return this.bind("focus click dblclick keydown keyup paste blur",l(function(){return this.update()},this))},this))}t(a,k);a.prototype.ready=function(a){return this.window!=null?a({type:"ready",target:this}):this.bind("ready",a)};a.prototype.update=function(){var a;a=this.iframe.getAttribute("previousContent");if(this.getValue()!==a)return this.fire({type:"change",
previous:a}),this.iframe.setAttribute("previousContent",this.getValue())};a.prototype.getValue=function(){if(this.window!=null)return this.body.innerHML};a.prototype.setValue=function(a){if(this.window!=null)return this.body.innerHTML=a,this.update()};return a}();this.Richarea=function(){function a(b){this.iframe=b;a.__super__.constructor.call(this,null);this.raw=new r(this.iframe);this.raw.ready(l(function(){this.api=new d(this);this.raw.bind("focus click dblclick keydown keypress keyup paste blur change",
l(function(a){a.target=this;return this.fire(a)},this));return this.bind("change",l(function(){return this.tidy()},this))},this))}t(a,k);a.detector=new h;a.prototype.tidy=function(){return q.tidy(this.raw.body,this.raw.document)};a.prototype.ready=function(a){return this.raw.ready(a)};a.prototype.getValue=function(){return this.raw.getValue()};a.prototype.setValue=function(a){return this.raw.setValue(a)};a.prototype.execCommand=function(a,b){b==null&&(b=void 0);this.api[a](b);return this.raw.update()};
return a}()}).call(this);
