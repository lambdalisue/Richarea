/*!
 * Richarea - A JavaScript contentEditable munipulator library v0.1.2
 * http://github.com/lambdalisue/Richarea
 * 
 * Copyright 2011 (c) hashnote.net, Alisue allright reserved.
 * Licensed under the MIT license.
 * 
 * Last-Modified: Mon, 07 Nov 2011 05:50:55 GMT
 */
(function(){function g(c){this._document=c;this.startContainer=this.endContainer=c.body;this.endOffset=b.getNodeLength(c.body)}function q(c){this.range=c;if(!c.collapsed){var e=c.commonAncestorContainer;this._next=c.startContainer==e&&!b.isDataNode(c.startContainer)?c.startContainer.childNodes[c.startOffset]:b.findClosestAncestor(e,c.startContainer);this._end=c.endContainer==e&&!b.isDataNode(c.endContainer)?c.endContainer.childNodes[c.endOffset]:b.findClosestAncestor(e,c.endContainer).nextSibling}}
function r(c){this._document=c;var b=this;c.attachEvent("onselectionchange",function(){b._selectionChangeHandler()})}var b={findChildPosition:function(c){for(var b=0;c=c.previousSibling;b++);return b},isDataNode:function(c){return c&&c.nodeValue!==null&&c.data!==null},isAncestorOf:function(c,e){return!b.isDataNode(c)&&(c.contains(b.isDataNode(e)?e.parentNode:e)||e.parentNode==c)},isAncestorOrSelf:function(c,e){return b.isAncestorOf(c,e)||c==e},findClosestAncestor:function(c,e){if(b.isAncestorOf(c,
e))for(;e&&e.parentNode!=c;)e=e.parentNode;return e},getNodeLength:function(c){return b.isDataNode(c)?c.length:c.childNodes.length},splitDataNode:function(c,e){if(!b.isDataNode(c))return false;var g=c.cloneNode(false);c.deleteData(e,c.length);g.deleteData(0,e);c.parentNode.insertBefore(g,c.nextSibling)}},t={convertToDOMRange:function(c,b){function i(c,g,o){var i=b.createElement("a"),m=g.duplicate();m.collapse(o);var a=m.parentElement();do a.insertBefore(i,i.previousSibling),m.moveToElementText(i);
while(m.compareEndPoints(o?"StartToStart":"StartToEnd",g)>0&&i.previousSibling);if(m.compareEndPoints(o?"StartToStart":"StartToEnd",g)==-1&&i.nextSibling)m.setEndPoint(o?"EndToStart":"EndToEnd",g),c[o?"setStart":"setEnd"](i.nextSibling,m.text.length);else c[o?"setStartBefore":"setEndBefore"](i);i.parentNode.removeChild(i)}var o=new g(b);i(o,c,true);i(o,c,false);return o},convertFromDOMRange:function(c){function e(c,e,g){var i=e[g?"startContainer":"endContainer"],q=e[g?"startOffset":"endOffset"],m=
0,a=b.isDataNode(i)?i:q===i.childNodes.length?null:i.childNodes[q],f=b.isDataNode(i)?i.parentNode:i;if(i.nodeType==3||i.nodeType==4)m=q;i=e._document.createElement("a");f.insertBefore(i,a);e=e._document.body.createTextRange();e.moveToElementText(i);i.parentNode.removeChild(i);c.setEndPoint(g?"StartToStart":"EndToStart",e);c[g?"moveStart":"moveEnd"]("character",m)}var g=c._document.body.createTextRange();e(g,c,true);e(g,c,false);return g}};g.START_TO_START=0;g.START_TO_END=1;g.END_TO_END=2;g.END_TO_START=
3;g.prototype={startContainer:null,startOffset:0,endContainer:null,endOffset:0,commonAncestorContainer:null,collapsed:false,_document:null,_refreshProperties:function(){this.collapsed=this.startContainer==this.endContainer&&this.startOffset==this.endOffset;for(var c=this.startContainer;c&&c!=this.endContainer&&!b.isAncestorOf(c,this.endContainer);)c=c.parentNode;this.commonAncestorContainer=c},setStart:function(c,b){this.startContainer=c;this.startOffset=b;this._refreshProperties()},setEnd:function(c,
b){this.endContainer=c;this.endOffset=b;this._refreshProperties()},setStartBefore:function(c){this.setStart(c.parentNode,b.findChildPosition(c))},setStartAfter:function(c){this.setStart(c.parentNode,b.findChildPosition(c)+1)},setEndBefore:function(c){this.setEnd(c.parentNode,b.findChildPosition(c))},setEndAfter:function(c){this.setEnd(c.parentNode,b.findChildPosition(c)+1)},selectNode:function(c){this.setStartBefore(c);this.setEndAfter(c)},selectNodeContents:function(c){this.setStart(c,0);this.setEnd(c,
b.getNodeLength(c))},collapse:function(c){c?this.setEnd(this.startContainer,this.startOffset):this.setStart(this.endContainer,this.endOffset)},cloneContents:function(){return function e(b){for(var g,k=document.createDocumentFragment();g=b.next();)g=g.cloneNode(!b.hasPartialSubtree()),b.hasPartialSubtree()&&g.appendChild(e(b.getSubtreeIterator())),k.appendChild(g);return k}(new q(this))},extractContents:function(){var c=this.cloneRange();this.startContainer!=this.commonAncestorContainer&&this.setStartAfter(b.findClosestAncestor(this.commonAncestorContainer,
this.startContainer));this.collapse(true);return function i(b){for(var c,g=document.createDocumentFragment();c=b.next();)b.hasPartialSubtree()?c=c.cloneNode(false):b.remove(),b.hasPartialSubtree()&&c.appendChild(i(b.getSubtreeIterator())),g.appendChild(c);return g}(new q(c))},deleteContents:function(){var c=this.cloneRange();this.startContainer!=this.commonAncestorContainer&&this.setStartAfter(b.findClosestAncestor(this.commonAncestorContainer,this.startContainer));this.collapse(true);(function i(b){for(;b.next();)b.hasPartialSubtree()?
i(b.getSubtreeIterator()):b.remove()})(new q(c))},insertNode:function(c){b.isDataNode(this.startContainer)?(b.splitDataNode(this.startContainer,this.startOffset),this.startContainer.parentNode.insertBefore(c,this.startContainer.nextSibling)):this.startContainer.insertBefore(c,this.startContainer.childNodes[this.startOffset]);this.setStart(this.startContainer,this.startOffset)},surroundContents:function(b){var e=this.extractContents();this.insertNode(b);console.log(this);b.appendChild(e);this.selectNode(b)},
compareBoundaryPoints:function(b,e){var i,o,k,p;switch(b){case g.START_TO_START:case g.START_TO_END:i=this.startContainer;o=this.startOffset;break;case g.END_TO_END:case g.END_TO_START:i=this.endContainer,o=this.endOffset}switch(b){case g.START_TO_START:case g.END_TO_START:k=e.startContainer;p=e.startOffset;break;case g.START_TO_END:case g.END_TO_END:k=e.endContainer,p=e.endOffset}return i.sourceIndex<k.sourceIndex?-1:i.sourceIndex==k.sourceIndex?o<p?-1:o==p?0:1:1},cloneRange:function(){var b=new g(this._document);
b.setStart(this.startContainer,this.startOffset);b.setEnd(this.endContainer,this.endOffset);return b},detach:function(){},toString:function(){return t.convertFromDOMRange(this).text},createContextualFragment:function(c){var e=(b.isDataNode(this.startContainer)?this.startContainer.parentNode:this.startContainer).cloneNode(false);e.innerHTML=c;for(c=this._document.createDocumentFragment();e.firstChild;)c.appendChild(e.firstChild);return c}};q.prototype={range:null,_current:null,_next:null,_end:null,
hasNext:function(){return!!this._next},next:function(){var c=this._current=this._next;this._next=this._current&&this._current.nextSibling!=this._end?this._current.nextSibling:null;b.isDataNode(this._current)&&(this.range.endContainer==this._current&&(c=c.cloneNode(true)).deleteData(this.range.endOffset,c.length-this.range.endOffset),this.range.startContainer==this._current&&(c=c.cloneNode(true)).deleteData(0,this.range.startOffset));return c},remove:function(){if(b.isDataNode(this._current)&&(this.range.startContainer==
this._current||this.range.endContainer==this._current)){var c=this.range.startContainer==this._current?this.range.startOffset:0;this._current.deleteData(c,(this.range.endContainer==this._current?this.range.endOffset:this._current.length)-c)}else this._current.parentNode.removeChild(this._current)},hasPartialSubtree:function(){return!b.isDataNode(this._current)&&(b.isAncestorOrSelf(this._current,this.range.startContainer)||b.isAncestorOrSelf(this._current,this.range.endContainer))},getSubtreeIterator:function(){var c=
new g(this.range._document);c.selectNodeContents(this._current);b.isAncestorOrSelf(this._current,this.range.startContainer)&&c.setStart(this.range.startContainer,this.range.startOffset);b.isAncestorOrSelf(this._current,this.range.endContainer)&&c.setEnd(this.range.endContainer,this.range.endOffset);return new q(c)}};r.prototype={rangeCount:0,_document:null,_selectionChangeHandler:function(){this.rangeCount=this._selectionExists(this._document.selection.createRange())?1:0},_selectionExists:function(b,
e){e===void 0&&(e=true);return b.compareEndPoints("StartToEnd",b)!=0||b.parentElement().isContentEditable&&e},addRange:function(b){var e=this._document.selection.createRange(),b=t.convertFromDOMRange(b);this._selectionExists(e,false)?(b.compareEndPoints("StartToStart",e)==-1&&(b.compareEndPoints("StartToEnd",e)>-1&&b.compareEndPoints("EndToEnd",e)==-1?e.setEndPoint("StartToStart",b):b.compareEndPoints("EndToStart",e)<1&&b.compareEndPoints("EndToEnd",e)>-1&&e.setEndPoint("EndToEnd",b)),e.select()):
b.select()},removeAllRanges:function(){this._document.selection.empty()},getRangeAt:function(){var b=this._document.selection.createRange();return this._selectionExists(b)?t.convertToDOMRange(b,this._document):null},toString:function(){return this._document.selection.createRange().text}};if(window.getSelection===void 0){document.createRange=function(){return new g(document)};var u=new r(document);window.getSelection=function(){return u};window.DOMRange=g;window.DOMSelection=r}})();
(function(){var g,q,r,b,t,u,c,e,i,o,k,p,s=Array.prototype.indexOf||function(a){for(var f=0,b=this.length;f<b;f++)if(this[f]===a)return f;return-1},v=Array.prototype.slice,m=function(a,f){return function(){return a.apply(f,arguments)}};t=function(){function a(){this.browser=this.searchString(a.dataBrowser)||"An unknown browser";this.version=this.searchVersion(navigator.userAgent)||this.searchVersion(navigator.appVersion)||"An unknown browser";this.OS=this.searchString(a.dataOS)||"An unknown OS"}a.prototype.searchString=
function(a){var b,d,c;for(d=0,c=a.length;d<c;d++)if(b=a[d],this.versionSearchString=b.versionSearch||b.identify,b.string!=null)if(b.string.indexOf(b.subString)!==-1)return b.identify;else if(b.prop)return b.identify;return[]};a.prototype.searchVersion=function(a){var b;b=a.indexOf(this.versionSearchString);return b===-1?void 0:parseFloat(a.substring(b+this.versionSearchString.length+1))};a.dataBrowser=[{string:navigator.userAgent,subString:"Chrome",identify:"Chrome"},{string:navigator.userAgent,subString:"OmniWeb",
versionSearch:"OmniWeb/",identify:"OmniWeb"},{string:navigator.vendor,subString:"Apple",identify:"Safari",versionSearch:"Version"},{prop:window.opera,identify:"Opera",versionSearch:"Version"},{string:navigator.vendor,subString:"iCab",identify:"iCab"},{string:navigator.vendor,subString:"KDE",identify:"Konqueror"},{string:navigator.userAgent,subString:"Firefox",identify:"Firefox"},{string:navigator.vendor,subString:"Camino",identify:"Camino"},{string:navigator.userAgent,subString:"Netscape",identify:"Netscape"},
{string:navigator.userAgent,subString:"MSIE",identify:"Explorer",versionSearch:"MSIE"},{string:navigator.userAgent,subString:"Gecko",identify:"Mozilla",versionSearch:"rv"},{string:navigator.userAgent,subString:"Mozilla",identify:"Netscape",versionSearch:"Mozilla"}];a.dataOS=[{string:navigator.platform,subString:"Win",identify:"Windows"},{string:navigator.platform,subString:"Mac",identify:"Mac"},{string:navigator.userAgent,subString:"iPhone",identify:"iPhone/iPad"},{string:navigator.platform,subString:"Linux",
identify:"Linux"}];return a}();if(typeof exports!=="undefined"&&exports!==null)exports.Detector=t;p=function(a,f){var b,d;for(d in f)b=f[d],a.prototype[d]=b;return a};if(typeof exports!=="undefined"&&exports!==null)exports.partial=p;u=function(){function a(){this.callbacks={}}a.prototype.get=function(a){this.callbacks[a]==null&&(this.callbacks[a]=[]);return this.callbacks[a]};a.prototype.add=function(a,b){var d,c,n,l,a=a.split(" ");l=[];for(c=0,n=a.length;c<n;c++){d=a[c];d=this.get(d);if(s.call(d,
b)>=0)throw new Exception("the events has already registered");l.push(d.push(b))}return l};a.prototype.remove=function(a,b){var d,c,n,l,e,g,i,a=a.split(" ");i=[];for(e=0,g=a.length;e<g;e++)l=a[e],c=this.get(l),i.push(function(){var a,f;f=[];for(d=0,a=c.length;d<a;d++)n=c[d],f.push(d===b?c.slice(n,1):void 0);return f}());return i};a.prototype.call=function(){var a,b,d,c,n,l,e,g;n=arguments[0];a=2<=arguments.length?v.call(arguments,1):[];n=n.split(" ");g=[];for(l=0,e=n.length;l<e;l++)c=n[l],d=this.get(c),
g.push(function(){var c,j,n;n=[];for(c=0,j=d.length;c<j;c++)b=d[c],n.push(b.apply(null,a));return n}());return g};return a}();b={CONTAINER_ELEMENTS:"body,div,center,blockquote,li,td".split(","),BLOCK_ELEMENTS:"address,dir,dl,form,h1,h2,h3,h4,h5,h6,hr,menu,noframes,ol,p,pre,table,ul,xmp".split(","),CLOSE_ELEMENTS:["img","br","hr"],isContainerNode:function(a){var f,a=(f=a.tagName)!=null?f.toLowerCase():void 0;return a!=null&&s.call(b.CONTAINER_ELEMENTS,a)>=0},isBlockNode:function(a){var f,a=(f=a.tagName)!=
null?f.toLowerCase():void 0;return a!=null&&s.call(b.BLOCK_ELEMENTS,a)>=0},isCloseNode:function(a){var f,a=(f=a.tagName)!=null?f.toLowerCase():void 0;return a!=null&&s.call(b.CLOSE_ELEMENTS,a)>=0},isInlineNode:function(a){return!(b.isContainerNode(a)||b.isBlockNode(a)||b.isDataNode(a))},isDataNode:function(a){return a!=null&&a.nodeType===3},isVisibleNode:function(a){var f,h,d;if(b.isDataNode(a))return a=b.getTextContent(a).replace(/[\s\t\r\n]/g,""),a.length!==0;else{d=a.childNodes;for(f=0,h=d.length;f<
h;f++)if(a=d[f],!b.isVisibleNode(a))return false;return true}},isIsolateNode:function(a){return!a.nextSibling&&!a.previousSibling},isAncestorOf:function(a,f){return!b.isDataNode(a)&&(a.contains(b.isDataNode(f)?f.parentNode:f)||f.parentNode===a)},isAncestorOrSelf:function(a,f){return a===f||b.isAncestorOf(a,f)},isEqual:function(a,f){var h,d,c,n;return a!=null&&f!=null&&a.nodeType===f.nodeType?b.isDataNode(a)?b.getTextContent(a)===b.getTextContent(f):(c=function(a,f){var b,d;if(a instanceof Object&&
f instanceof Object)for(b in a){if(d=a[b],c(d,f[b]))return false}else if(a instanceof Array&&f instanceof Array){if(a.length!==f.length)return false;for(b=0,d=a.length;0<=d?b<d:b>d;0<=d?b++:b--)if(a[b]!==f[b])return false}else if(a!==f)return false;return true},h=((d=a.tagName)!=null?d.toLowerCase():void 0)===((n=f.tagName)!=null?n.toLowerCase():void 0),d=c(a.styles,f.styles),h&&d):false},createElementFromHTML:function(a){var b;b=document.createElement("div");b.innerHTML=a;return b.firstChild},getTextContent:function(a){return a.textContent||
a.nodeValue},setTextContent:function(a,b){return a.textContent!=null?a.textContent=b:a.nodeValue=b},getNodeLength:function(a){return b.isDataNode(a)?a.length:a.childNodes.length},findClosestAncestor:function(a,f){if(b.isAncestorOf(a,f))for(;f&&f.parentNode!==a;)f=f.parentNode;return f},findChildPosition:function(a){var b;for(b=0;(a=a.previousSibling)!=null;)b++;return b},findUpstreamNode:function(a,b,h){for(var d;a!=null;){if(d=b(a))return a;a=a.parentNode;if(h!=null&&h(node))break}return null},findTerminalNode:function(a,
b){b==null&&(b=false);if(b)for(;a!=null&&a.lastChild!=null;)a=a.lastChild;else for(;a!=null&&a.firstChild!=null;)a=a.firstChild;return a},findNextNode:function(a){a=b.findUpstreamNode(a,function(a){return a.nextSibling!=null});return a!=null?a.nextSibling:void 0},findPreviousNode:function(a){a=b.findUpstreamNode(a,function(a){return a.previousSibling!=null});return a!=null?a.previousSibling:void 0},findNextTerminalNode:function(a){a=b.findNextNode(a);return a=b.findTerminalNode(a)},findNextDataNode:function(a){console.warn("use DOMUtils.findNextTerminalNode insted");
return b.findNextTerminalNode(a)},findPreviousTerminalNode:function(a){a=b.findPreviousNode(a);return a=b.findTerminalNode(a,true)},findPreviousDataNode:function(a){console.warn("use DOMUtils.findPreviousTerminalNode insted");return b.findPreviousTerminalNode(a)},applyToAllTerminalNodes:function(a,f,h){var d,c,a=b.findTerminalNode(a),f=b.findTerminalNode(f);for(c=[];a!=null;){d=b.findNextTerminalNode(a);h(a);if(a===f)break;c.push(a=d)}return c},splitDataNode:function(a,f){var c;if(!b.isDataNode(a))return false;
c=a.cloneNode(false);a.deleteData(f,a.length);c.deleteData(0,f);a.parentNode.insertBefore(c,a.nextSibling);return c},extractDataNode:function(a,f,c){var d,j,n,e;f==null&&(f=void 0);c==null&&(c=void 0);if(!b.isDataNode(a))return false;j=b.getTextContent(a);f==null&&(f=0);if(c==null)c=j.length;if(f===c||f===0&&c===j.length)return a;d=j.substring(0,f);f=j.substring(f,c);n=j.substring(c,j.length);c=a.nextSibling;j=a.parentNode;j.removeChild(a);a=document;d.length>0&&(d=a.createTextNode(d),b.isVisibleNode(d)&&
j.insertBefore(d,c));f.length>0&&(e=a.createTextNode(f),j.insertBefore(e,c));n.length>0&&(d=a.createTextNode(n),b.isVisibleNode(d)&&j.insertBefore(d,c));return e},concatDataNode:function(a,f){a.parentNode.removeChild(f);b.setTextContent(a,b.getTextContent(a)+b.getTextContent(f));return a},concatNode:function(a,b){for(b.parentNode.removeChild(b);b.firstChild!=null;)a.appendChild(b.firstChild);return a}};r={add:function(a,b,c){var d,j,n,e,b=b.split(" ");e=[];for(j=0,n=b.length;j<n;j++)d=b[j],e.push(a.attachEvent!=
null?a.attachEvent("on"+d,c):a.addEventListener(d,c,false));return e}};c={_tidyInline:function(a){var f,h,d,j;h=a.firstChild;for(j=[];h!=null;)a=h.nextSibling,b.isContainerNode(h)?(d=function(a){return b.isContainerNode(a)},f=b.findUpstreamNode(h,d),d=h.cloneNode(false),k.remove(h),k._container(f,d)):b.isBlockNode(h)?(d=function(a){return b.isContainerNode(a)},f=b.findUpstreamNode(h,d),d=h.cloneNode(false),k.remove(h),k._block(f,d)):b.isInlineNode(h)&&(d=function(a){return b.isEqual(a,h)},f=function(a){return!b.isInlineNode(a)},
f=b.findUpstreamNode(h,d,f),f!=null&&k.remove(h)),b.isInlineNode(h)&&c._tidyInline(h),j.push(h=a);return j},_tidyBlock:function(a){var f,h,d,j,a=a.firstChild;for(j=[];a!=null;){h=a.nextSibling;if(b.isContainerNode(a))f=function(a){return b.isContainerNode(a)},f=b.findUpstreamNode(a,f),d=a.cloneNode(false),k.remove(a),k._container(f,d);else if(b.isBlockNode(a))f=function(a){return b.isContainerNode(a)},f=b.findUpstreamNode(a,f),d=a.cloneNode(false),k.remove(a),k._block(f,d);else if(h!=null)if(b.isDataNode(a)&&
b.isDataNode(h)){a=b.concatDataNode(a,h);continue}else if(b.isInlineNode(a)&&b.isInlineNode(h)&&!b.isCloseNode(a)&&b.isEqual(a,h)){a=b.concatNode(a,h);continue}b.isBlockNode(a)?c._tidyBlock(a):b.isInlineNode(a)&&c._tidyInline(a);j.push(a=h)}return j},_tidyContainer:function(a){var f,h,d,a=a.firstChild;for(d=[];a!=null;){h=a.nextSibling;if(b.isContainerNode(a)||b.isBlockNode(a)){if(!b.isDataNode(h)||s.call(b.getTextContent(h),"\n")<0)f=document.createTextNode("\n"),a.parentNode.insertBefore(f,h)}else if(b.isVisibleNode(a)){a=
k.out(a,document.createElement("p"));continue}b.isContainerNode(a)?c._tidyContainer(a):b.isBlockNode(a)&&c._tidyBlock(a);d.push(a=h)}return d},tidy:function(a,b){var h,d,j,e,g,i,k;k=new o(b);e=k.getSelection();if(e.rangeCount>0)j=e.getRangeAt(0),g=j.startContainer,i=j.startOffset,h=j.endContainer,d=j.endOffset,e.removeAllRanges();c._tidyContainer(a);if(g!=null)return j=k.createRange(),j.setStart(g,i),j.setEnd(h,d),k.setSelection(j)}};o=function(){function a(a){var b;this.document=a;this.window=this.document.defaultView||
this.document.parentWindow;if(this.document.createRange==null&&window.IERange!=null)this.document.createRange=m(function(){return new IERange(this.document)},this),b=new IESelection(this.document),this.window.getSelection=m(function(){this.document.body.focus();return b},this)}a.prototype.getSelection=function(){return this.window.getSelection()};a.prototype.setSelection=function(a){var b;b=this.getSelection();b.removeAllRanges();return b.addRange(a)};a.prototype.getRangeAt=function(a){return this.getSelection().getRangeAt(a)};
a.prototype.createRange=function(){return this.document.createRange()};return a}();i=function(){function a(a,b,c,j){this.startContainer=a;this.startOffset=b;this.endContainer=c;this.endOffset=j}a.prototype.setStart=function(a,b){b==null&&(b=0);this.startContainer=a;return this.startOffset=b};a.prototype.setEnd=function(a,b){var c;if(b==null)a.firstChild!=null?b=a.childNodes.length:(c=a.textContent||a.nodeValue,b=c.length);this.endContainer=a;return this.endOffset=b};a.prototype.attach=function(a){a.setStart(this.startContainer,
this.startOffset);a.setEnd(this.endContainer,this.endOffset);return a};return a}();k={out:function(a,b){var c,d,b=b.cloneNode(false);c=a.nextSibling;d=a.parentNode;b.appendChild(a);d.insertBefore(b,c);return b},"in":function(a,b){for(b=b.cloneNode(false);a.firstChild!=null;)b.appendChild(a.firstChild);a.appendChild(b);return a},replace:function(a,b){for(var c,b=b.cloneNode(false);a.firstChild;)b.appendChild(a.firstChild);c=a.parentNode;c.insertBefore(b,a);c.removeChild(a);return b},remove:function(a){var b,
c;b=a.nextSibling;c=a.parentNode;for(c.removeChild(a);a.firstChild;)c.insertBefore(a.firstChild,b);return c},each:function(a,c,h,d,j){d==null&&(d=[]);if(j==null)j=k.out;return b.applyToAllTerminalNodes(a,c,function(a){if(s.call(d,a)<0&&b.isVisibleNode(a))return j(a,h)})},research:function(a,c,h,d){var j,e,g;d==null&&(d=[]);j=h.tagName.toLowerCase();g=function(a){var b;return((b=a.tagName)!=null?b.toLowerCase():void 0)===j};e=[];b.applyToAllTerminalNodes(a,c,function(a){var c;if(s.call(d,a)<0&&b.isVisibleNode(a))return c=
b.findUpstreamNode(a,g),e.push({node:a,found:c})});return e},_container:function(a,c){var h;h=b.findUpstreamNode(a,function(a){return b.isBlockNode(a)&&b.isContainerNode(a.parentNode)});a=k.out(h,c);h=new i;h.setStart(a);h.setEnd(a);return h},_containerRemove:function(a,c){var h,d,e;d=b.findUpstreamNode(a,function(a){return b.isEqual(a,c)});d!=null?(e=b.findPreviousNode(d),h=b.findNextNode(d),k.remove(d),d=new i,d.setStart(b.findNextNode(e)),d.setEnd(b.findPreviousNode(h))):(d=new i,d.setStart(a),
d.setEnd(a));return d},_block:function(a,c,h){var d;h==null&&(h=true);d=b.findUpstreamNode(a,function(a){return b.isBlockNode(a)});if(d!=null)if(b.isEqual(d,c))if(h)a=k.replace(d,document.createElement("p"));else return c=b.findPreviousNode(d),a=b.findNextNode(d),k.remove(d),d=new i,d.setStart(b.findNextNode(c)),d.setEnd(b.findPreviousNode(a)),d;else a=k.replace(d,c);else d=b.findUpstreamNode(a,function(a){return b.isContainerNode(a)}),a=k["in"](d,c);d=new i;d.setStart(a);d.setEnd(a);return d},_inline:function(a,
c,h,d){var e,g,l,m,o,a=b.findUpstreamNode(a,function(a){return b.isEqual(a,d)});if(a!=null){if(g=a.firstChild,l=a.lastChild,a=k.remove(a),e=[],b.applyToAllTerminalNodes(c,h,function(a){return e.push(a)}),k.each(g,l,d,e),c===h&&b.isDataNode(c)&&(l=c.previousSibling,l!=null&&b.isDataNode(l)))return g=c,c=l!=null?l.length:0,h=c+g.length,g=b.concatDataNode(l,g),l=new i,l.setStart(g,c),l.setEnd(g,h),l}else{l=k.research(c,h,d);a=true;for(m=0,o=l.length;m<o;m++)if(g=l[m],g.found==null){a=false;break}if(a)for(a=
0,m=l.length;a<m;a++)g=l[a],g.found!=null&&k.remove(g.found);else for(a=0,m=l.length;a<m;a++)g=l[a],g.found==null&&k.out(g.node,d)}l=new i;l.setStart(c);l.setEnd(h);return l},range:function(a,c,h){var d,e,g;h==null&&(h=false);return b.isContainerNode(c)?h?k._containerRemove(a.commonAncestorContainer,c):k._container(a.commonAncestorContainer,c):b.isBlockNode(c)?k._block(a.commonAncestorContainer,c):(e=a.startContainer,g=a.startOffset,h=a.endContainer,d=a.endOffset,a=a.commonAncestorContainer,e===h&&
b.isDataNode(e)?(e=h=b.extractDataNode(e,g,d),a=e.parentNode):(e=b.isDataNode(e)?b.extractDataNode(e,g):e.childNodes[g],h=b.isDataNode(h)?b.extractDataNode(h,null,d):h.childNodes[d-1]),k._inline(a,e,h,c))}};g=function(){function a(a){this.richarea=a;this.richarea.ready(m(function(){return this.selection=new o(this.richarea.raw.document)},this))}a.prototype.execCommand=function(a,c){var d,e;d=this.selection.getSelection();e=d.getRangeAt(0);d.removeAllRanges();switch(a){case "surround":d=b.createElementFromHTML(c);
d=k.range(e,d);e=this.selection.createRange();e=d.attach(e);break;case "unsurround":d=b.createElementFromHTML(c),d=k.range(e,d,true),e=this.selection.createRange(),e=d.attach(e)}this.selection.setSelection(e);return true};return a}();if(typeof require!=="undefined"&&require!==null)p=require("../utils/partial").partial,g=require("./api.core").API;g=p(g,{indent:function(){return this.raw.execCommand("indent")},outdent:function(){return this.raw.execCommand("outdent")}});if(typeof exports!=="undefined"&&
exports!==null)exports.API=g;g=p(g,{blockquote:function(){return this.execCommand("surround","<blockquote>")},unblockquote:function(){return this.execCommand("unsurround","<blockquote>")},heading:function(a){return this.execCommand("surround","<h"+a+">")},h1:function(){return this.heading(1)},h2:function(){return this.heading(2)},h3:function(){return this.heading(3)},h4:function(){return this.heading(4)},h5:function(){return this.heading(5)},h6:function(){return this.heading(6)},p:function(){return this.execCommand("surround",
"<p>")},pre:function(){return this.execCommand("surround","<pre>")}});g=p(g,{strong:function(){return this.execCommand("surround","<strong>")},em:function(){return this.execCommand("surround","<em>")},ins:function(){return this.execCommand("surround","<ins>")},del:function(){return this.execCommand("surround","<del>")},sub:function(){return this.execCommand("surround","<sub>")},sup:function(){return this.execCommand("surround","<sup>")}});g=p(g,{a:function(a){return this.execCommand("surround","<a href='"+
a+"'>")},img:function(a){return this.execCommand("insert","<img src='"+a+"'>")},ul:function(){return this.raw.execCommand("insertUnorderedList")},ol:function(){return this.raw.execCommand("insertOrderedList")},hr:function(){return this.raw.execCommand("insertHorizontalRule")},table:function(a){var b,c,d,e,g;a==null&&(a=[5,5,"Table Caption"]);d=a[0];b=a[1];a=a[2];e=function(){var a;a=[];for(c=0;0<=b?c<b:c>b;0<=b?c++:c--)a.push("    <td>XXX</td>");return a}();g=function(){var a;a=[];for(c=0;0<=d?c<
d:c>d;0<=d?c++:c--)a.push("  <tr>\n"+e.join("\n")+"\n  </tr>");return a}();return this.execCommand("insert","<table>"+(a!=null?"\n<caption>"+a+"</caption>":"")+"\n"+g.join("\n")+"\n</table>")}});g=p(g,{forecolor:function(a){return this.execCommand("style",{color:a})},backcolor:function(a){return this.execCommand("style",{backgroundColor:a})},fontfamily:function(a){return this.execCommand("style",{fontFamily:a})},fontsize:function(a){return this.execCommand("style",{fontSize:a})},justifyleft:function(){return this.execCommand("style",
{textAlign:"left"},true)},justifycenter:function(){return this.execCommand("style",{textAlign:"center"},true)},justifyright:function(){return this.execCommand("style",{textAlign:"right"},true)},justifyfull:function(){return this.execCommand("style",{textAlign:"justify"},true)}});q=function(){return function(a){var b;this.iframe=a;this.window=this.iframe.contentWindow;this.document=this.iframe.contentDocument||this.window.document;this.document.body==null&&this.document.writeln("<body></body>");this.body=
this.document.body;this.body.style.cursor="text";this.body.style.height="100%";Richarea.detector.browser==="Explorer"&&Richarea.detector.version<9&&(b=m(function(){return this.body.style.height=""+this.iframe.offsetHeight+"px"},this),setTimeout(m(function(){var a,c;((a=this.iframe)!=null?a.offsetHeight:void 0)!==((c=this.body)!=null?c.offsetHeight:void 0)&&b();return setTimeout(arguments.callee,100)},this),100));if(this.body.spellcheck!=null)this.body.spellcheck=false;if(this.body.contentEditable!=
null)this.body.contentEditable=true;else if(this.document.designMode!=null)this.document.designMode="On"}}();e=function(){function a(a){this.iframe=a;this._loaded=false;this.event=new u;this.event.add("ready",m(function(){return this._loaded=true},this));Richarea.detector.browser==="Explorer"&&Richarea.detector.version<9?this.iframe.attachEvent("onreadystatechange",m(function(){if(this.iframe.readyState==="complete")return this.iframe.onreadystatechange=null,this.event.call("ready")},this)):this.iframe.addEventListener("load",
m(function(){return this.event.call("ready")},this),false)}a.prototype.ready=function(a){return this.event.add("ready",a)};a.prototype.loaded=function(){return this._loaded};return a}();this.Richarea=function(){function a(a){this.iframe=a;this.raw=this.loader=null;this.event=new u;this.event.add("ready",m(function(){var a,b,c,e,f;this.raw=new q(this.iframe);c=m(function(a,b){return this.raw.body.contentEditable!=null?r.add(this.raw.body,a,b):r.add(this.raw.document,a,b)},this);b="keydown,keypress,keyup,click,focus,blur,paste".split(",");
for(e=0,f=b.length;e<f;e++)a=b[e],c(a,m(function(){var b;b=1<=arguments.length?v.call(arguments,0):[];return this.event.call.apply(this.event,[a].concat(b))},this));this.event.add("focus",m(function(){return this.raw.body.setAttribute("previousInnerHTML",this.raw.body.innerHTML)},this));this.event.add("click focus blur keydown keyup paste",m(function(){return this._change()},this));this.api=new g(this);return this.tidy()},this));this.iframe.getAttribute("src")!=null?(this.loader=new e(this.iframe),
this.loader.ready(m(function(){return this.event.call("ready")},this))):this.event.call("ready")}a.detector=new t;a.prototype._change=function(){this.tidy();if(this.raw.body.getAttribute("previousInnerHTML")!==this.raw.body.innerHTML)return this.raw.body.setAttribute("previousInnerHTML",this.raw.body.innerHTML),this.event.call("change")};a.prototype.tidy=function(){return c.tidy(this.raw.body,this.raw.document)};a.prototype.ready=function(a){return this.loader==null||this.loader.loaded()?a():this.loader.ready(a)};
a.prototype.getValue=function(){var a;if(this.raw!=null)return((a=this.raw.body)!=null?a.innerHTML:void 0)!=null};a.prototype.setValue=function(a){var b;if(this.raw!=null){if((b=this.raw.body)!=null)b.innerHTML=a;return this._change()}};a.prototype.execCommand=function(a,b){var c;b==null&&(b=void 0);if(a in this.api)return this.api[a](b),this._change();else if(((c=window.console)!=null?c.error:void 0)!=null)return console.error("Command '"+a+"' not found.")};return a}()}).call(this);
