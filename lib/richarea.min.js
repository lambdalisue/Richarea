/*!
 * Richarea - A JavaScript contentEditable munipulator library v0.2.0
 * http://github.com/lambdalisue/Richarea
 * 
 * Copyright 2011 (c) hashnote.net, Alisue allright reserved.
 * Licensed under the MIT license.
 * 
 * Last-Modified: Mon, 07 Nov 2011 09:45:31 GMT
 */
(function(){function l(g){this._document=g;this.startContainer=this.endContainer=g.body;this.endOffset=i.getNodeLength(g.body)}function b(g){this.range=g;if(!g.collapsed){var b=g.commonAncestorContainer;this._next=g.startContainer==b&&!i.isDataNode(g.startContainer)?g.startContainer.childNodes[g.startOffset]:i.findClosestAncestor(b,g.startContainer);this._end=g.endContainer==b&&!i.isDataNode(g.endContainer)?g.endContainer.childNodes[g.endOffset]:i.findClosestAncestor(b,g.endContainer).nextSibling}}
function p(g){this._document=g;var b=this;g.attachEvent("onselectionchange",function(){b._selectionChangeHandler()})}var i={findChildPosition:function(g){for(var b=0;g=g.previousSibling;b++);return b},isDataNode:function(g){return g&&g.nodeValue!==null&&g.data!==null},isAncestorOf:function(g,b){return!i.isDataNode(g)&&(g.contains(i.isDataNode(b)?b.parentNode:b)||b.parentNode==g)},isAncestorOrSelf:function(g,b){return i.isAncestorOf(g,b)||g==b},findClosestAncestor:function(g,b){if(i.isAncestorOf(g,
b))for(;b&&b.parentNode!=g;)b=b.parentNode;return b},getNodeLength:function(g){return i.isDataNode(g)?g.length:g.childNodes.length},splitDataNode:function(g,b){if(!i.isDataNode(g))return false;var j=g.cloneNode(false);g.deleteData(b,g.length);j.deleteData(0,b);g.parentNode.insertBefore(j,g.nextSibling)}},n={convertToDOMRange:function(b,h){function i(b,g,k){var a=h.createElement("a"),d=g.duplicate();d.collapse(k);var e=d.parentElement();do e.insertBefore(a,a.previousSibling),d.moveToElementText(a);
while(d.compareEndPoints(k?"StartToStart":"StartToEnd",g)>0&&a.previousSibling);if(d.compareEndPoints(k?"StartToStart":"StartToEnd",g)==-1&&a.nextSibling)d.setEndPoint(k?"EndToStart":"EndToEnd",g),b[k?"setStart":"setEnd"](a.nextSibling,d.text.length);else b[k?"setStartBefore":"setEndBefore"](a);a.parentNode.removeChild(a)}var k=new l(h);i(k,b,true);i(k,b,false);return k},convertFromDOMRange:function(b){function h(b,g,h){var j=g[h?"startContainer":"endContainer"],a=g[h?"startOffset":"endOffset"],d=
0,e=i.isDataNode(j)?j:a===j.childNodes.length?null:j.childNodes[a],c=i.isDataNode(j)?j.parentNode:j;if(j.nodeType==3||j.nodeType==4)d=a;j=g._document.createElement("a");c.insertBefore(j,e);g=g._document.body.createTextRange();g.moveToElementText(j);j.parentNode.removeChild(j);b.setEndPoint(h?"StartToStart":"EndToStart",g);b[h?"moveStart":"moveEnd"]("character",d)}var j=b._document.body.createTextRange();h(j,b,true);h(j,b,false);return j}};l.START_TO_START=0;l.START_TO_END=1;l.END_TO_END=2;l.END_TO_START=
3;l.prototype={startContainer:null,startOffset:0,endContainer:null,endOffset:0,commonAncestorContainer:null,collapsed:false,_document:null,_refreshProperties:function(){this.collapsed=this.startContainer==this.endContainer&&this.startOffset==this.endOffset;for(var b=this.startContainer;b&&b!=this.endContainer&&!i.isAncestorOf(b,this.endContainer);)b=b.parentNode;this.commonAncestorContainer=b},setStart:function(b,h){this.startContainer=b;this.startOffset=h;this._refreshProperties()},setEnd:function(b,
h){this.endContainer=b;this.endOffset=h;this._refreshProperties()},setStartBefore:function(b){this.setStart(b.parentNode,i.findChildPosition(b))},setStartAfter:function(b){this.setStart(b.parentNode,i.findChildPosition(b)+1)},setEndBefore:function(b){this.setEnd(b.parentNode,i.findChildPosition(b))},setEndAfter:function(b){this.setEnd(b.parentNode,i.findChildPosition(b)+1)},selectNode:function(b){this.setStartBefore(b);this.setEndAfter(b)},selectNodeContents:function(b){this.setStart(b,0);this.setEnd(b,
i.getNodeLength(b))},collapse:function(b){b?this.setEnd(this.startContainer,this.startOffset):this.setStart(this.endContainer,this.endOffset)},cloneContents:function(){return function h(b){for(var i,m=document.createDocumentFragment();i=b.next();)i=i.cloneNode(!b.hasPartialSubtree()),b.hasPartialSubtree()&&i.appendChild(h(b.getSubtreeIterator())),m.appendChild(i);return m}(new b(this))},extractContents:function(){var g=this.cloneRange();this.startContainer!=this.commonAncestorContainer&&this.setStartAfter(i.findClosestAncestor(this.commonAncestorContainer,
this.startContainer));this.collapse(true);return function j(b){for(var g,i=document.createDocumentFragment();g=b.next();)b.hasPartialSubtree()?g=g.cloneNode(false):b.remove(),b.hasPartialSubtree()&&g.appendChild(j(b.getSubtreeIterator())),i.appendChild(g);return i}(new b(g))},deleteContents:function(){var g=this.cloneRange();this.startContainer!=this.commonAncestorContainer&&this.setStartAfter(i.findClosestAncestor(this.commonAncestorContainer,this.startContainer));this.collapse(true);(function j(b){for(;b.next();)b.hasPartialSubtree()?
j(b.getSubtreeIterator()):b.remove()})(new b(g))},insertNode:function(b){i.isDataNode(this.startContainer)?(i.splitDataNode(this.startContainer,this.startOffset),this.startContainer.parentNode.insertBefore(b,this.startContainer.nextSibling)):this.startContainer.insertBefore(b,this.startContainer.childNodes[this.startOffset]);this.setStart(this.startContainer,this.startOffset)},surroundContents:function(b){var h=this.extractContents();this.insertNode(b);console.log(this);b.appendChild(h);this.selectNode(b)},
compareBoundaryPoints:function(b,h){var i,k,m,n;switch(b){case l.START_TO_START:case l.START_TO_END:i=this.startContainer;k=this.startOffset;break;case l.END_TO_END:case l.END_TO_START:i=this.endContainer,k=this.endOffset}switch(b){case l.START_TO_START:case l.END_TO_START:m=h.startContainer;n=h.startOffset;break;case l.START_TO_END:case l.END_TO_END:m=h.endContainer,n=h.endOffset}return i.sourceIndex<m.sourceIndex?-1:i.sourceIndex==m.sourceIndex?k<n?-1:k==n?0:1:1},cloneRange:function(){var b=new l(this._document);
b.setStart(this.startContainer,this.startOffset);b.setEnd(this.endContainer,this.endOffset);return b},detach:function(){},toString:function(){return n.convertFromDOMRange(this).text},createContextualFragment:function(b){var h=(i.isDataNode(this.startContainer)?this.startContainer.parentNode:this.startContainer).cloneNode(false);h.innerHTML=b;for(b=this._document.createDocumentFragment();h.firstChild;)b.appendChild(h.firstChild);return b}};b.prototype={range:null,_current:null,_next:null,_end:null,
hasNext:function(){return!!this._next},next:function(){var b=this._current=this._next;this._next=this._current&&this._current.nextSibling!=this._end?this._current.nextSibling:null;i.isDataNode(this._current)&&(this.range.endContainer==this._current&&(b=b.cloneNode(true)).deleteData(this.range.endOffset,b.length-this.range.endOffset),this.range.startContainer==this._current&&(b=b.cloneNode(true)).deleteData(0,this.range.startOffset));return b},remove:function(){if(i.isDataNode(this._current)&&(this.range.startContainer==
this._current||this.range.endContainer==this._current)){var b=this.range.startContainer==this._current?this.range.startOffset:0;this._current.deleteData(b,(this.range.endContainer==this._current?this.range.endOffset:this._current.length)-b)}else this._current.parentNode.removeChild(this._current)},hasPartialSubtree:function(){return!i.isDataNode(this._current)&&(i.isAncestorOrSelf(this._current,this.range.startContainer)||i.isAncestorOrSelf(this._current,this.range.endContainer))},getSubtreeIterator:function(){var g=
new l(this.range._document);g.selectNodeContents(this._current);i.isAncestorOrSelf(this._current,this.range.startContainer)&&g.setStart(this.range.startContainer,this.range.startOffset);i.isAncestorOrSelf(this._current,this.range.endContainer)&&g.setEnd(this.range.endContainer,this.range.endOffset);return new b(g)}};p.prototype={rangeCount:0,_document:null,_selectionChangeHandler:function(){this.rangeCount=this._selectionExists(this._document.selection.createRange())?1:0},_selectionExists:function(b,
h){h===void 0&&(h=true);return b.compareEndPoints("StartToEnd",b)!=0||b.parentElement().isContentEditable&&h},addRange:function(b){var h=this._document.selection.createRange(),b=n.convertFromDOMRange(b);this._selectionExists(h,false)?(b.compareEndPoints("StartToStart",h)==-1&&(b.compareEndPoints("StartToEnd",h)>-1&&b.compareEndPoints("EndToEnd",h)==-1?h.setEndPoint("StartToStart",b):b.compareEndPoints("EndToStart",h)<1&&b.compareEndPoints("EndToEnd",h)>-1&&h.setEndPoint("EndToEnd",b)),h.select()):
b.select()},removeAllRanges:function(){this._document.selection.empty()},getRangeAt:function(){var b=this._document.selection.createRange();return this._selectionExists(b)?n.convertToDOMRange(b,this._document):null},toString:function(){return this._document.selection.createRange().text}};if(window.getSelection===void 0){document.createRange=function(){return new l(document)};var o=new p(document);window.getSelection=function(){return o};window.DOMRange=l;window.DOMSelection=p}})();
(function(){var l,b,p,i,n,o,g,h,j,k=Array.prototype.indexOf||function(a){for(var d=0,b=this.length;d<b;d++)if(this[d]===a)return d;return-1},m=function(a,d){return function(){return a.apply(d,arguments)}},s=Object.prototype.hasOwnProperty,r=function(a,d){function b(){this.constructor=a}for(var c in d)s.call(d,c)&&(a[c]=d[c]);b.prototype=d.prototype;a.prototype=new b;a.__super__=d.prototype;return a};p=function(){function a(){this.browser=this.searchString(a.dataBrowser)||"An unknown browser";this.version=
this.searchVersion(navigator.userAgent)||this.searchVersion(navigator.appVersion)||"An unknown browser";this.OS=this.searchString(a.dataOS)||"An unknown OS"}a.prototype.searchString=function(a){var b,c,f;for(c=0,f=a.length;c<f;c++)if(b=a[c],this.versionSearchString=b.versionSearch||b.identify,b.string!=null)if(b.string.indexOf(b.subString)!==-1)return b.identify;else if(b.prop)return b.identify;return[]};a.prototype.searchVersion=function(a){var b;b=a.indexOf(this.versionSearchString);return b===
-1?void 0:parseFloat(a.substring(b+this.versionSearchString.length+1))};a.dataBrowser=[{string:navigator.userAgent,subString:"Chrome",identify:"Chrome"},{string:navigator.userAgent,subString:"OmniWeb",versionSearch:"OmniWeb/",identify:"OmniWeb"},{string:navigator.vendor,subString:"Apple",identify:"Safari",versionSearch:"Version"},{prop:window.opera,identify:"Opera",versionSearch:"Version"},{string:navigator.vendor,subString:"iCab",identify:"iCab"},{string:navigator.vendor,subString:"KDE",identify:"Konqueror"},
{string:navigator.userAgent,subString:"Firefox",identify:"Firefox"},{string:navigator.vendor,subString:"Camino",identify:"Camino"},{string:navigator.userAgent,subString:"Netscape",identify:"Netscape"},{string:navigator.userAgent,subString:"MSIE",identify:"Explorer",versionSearch:"MSIE"},{string:navigator.userAgent,subString:"Gecko",identify:"Mozilla",versionSearch:"rv"},{string:navigator.userAgent,subString:"Mozilla",identify:"Netscape",versionSearch:"Mozilla"}];a.dataOS=[{string:navigator.platform,
subString:"Win",identify:"Windows"},{string:navigator.platform,subString:"Mac",identify:"Mac"},{string:navigator.userAgent,subString:"iPhone",identify:"iPhone/iPad"},{string:navigator.platform,subString:"Linux",identify:"Linux"}];return a}();if(typeof exports!=="undefined"&&exports!==null)exports.Detector=p;j=function(a,d){var b,c;for(c in d)b=d[c],a.prototype[c]=b;return a};if(typeof exports!=="undefined"&&exports!==null)exports.partial=j;i=function(){function a(a){this.target=a;this._eventListeners=
{}}a.prototype.addEventListener=function(a,b){this._eventListeners[a]==null&&(this._eventListeners[a]=[]);return this._eventListeners[a].push(b)};a.prototype.removeEventListener=function(a,b){var c,f,g,h,i;if(this._eventListeners[a]instanceof Array){f=this._eventListeners[a];i=[];for(c=0,g=f.length;c<g;c++)if(h=f[c],h===b){f.splice(c,1);break}return i}};a.prototype.bind=function(a,b){var c,f,g,h,a=a.split(" ");h=[];for(f=0,g=a.length;f<g;f++)c=a[f],h.push(this.addEventListener(c,b));return h};a.prototype.unbind=
function(a,b){var c,f,g,h,a=a.split(" ");h=[];for(f=0,g=a.length;f<g;f++)c=a[f],h.push(this.removeEventListener(c,b));return h};a.prototype.fire=function(a){var b,c,f,g,h;typeof a==="string"&&(a={type:a});if(a.target==null)a.target=this.target||this;if(a.type==null)throw Error("Event objet missing `type` property");if(this._eventListeners[a.type]instanceof Array){c=this._eventListeners[a.type];h=[];for(f=0,g=c.length;f<g;f++)b=c[f],h.push(b.call(this.target||this,a));return h}};a.addEventListener=
function(d,b,c){if(d.__event==null)d.__event=new a(d);return d.__event.addEventListener(b,c)};a.removeEventListener=function(a,b,c){if(a.__event!=null)return a.__event.removeEventListener(b,c)};a.addDOMEventListener=function(a,b,c){return a.attachEvent!=null?a.attachEvent("on"+b,c):a.addEventListener(b,c,false)};a.removeDOMEventListener=function(a,b,c){return a.detachEvent!=null?a.detachEvent("on"+b,c):a.removeEventListener(b,c,false)};a.bind=function(b,e,c){var f,g,h,i,q;f=b instanceof Node||b.toString!=
null&&b.toString()==="[object HTMLBodyElement]"?a.addDOMEventListener:a.addEventListener;e=e.split(" ");q=[];for(h=0,i=e.length;h<i;h++)g=e[h],q.push(f(b,g,c));return q};a.unbind=function(b,e,c){var f,g,h,i,q;f=b instanceof Node?a.removeDOMEventListener:a.removeEventListener;e=e.split(" ");q=[];for(h=0,i=e.length;h<i;h++)g=e[h],q.push(f(b,g,c));return q};a.fire=function(a,b){return a.__event==null?void 0:a.__event.fire(b)};return a}();b={CONTAINER_ELEMENTS:"body,div,center,blockquote,li,td".split(","),
BLOCK_ELEMENTS:"address,dir,dl,form,h1,h2,h3,h4,h5,h6,hr,menu,noframes,ol,p,pre,table,ul,xmp".split(","),CLOSE_ELEMENTS:["img","br","hr"],isContainerNode:function(a){var d,a=(d=a.tagName)!=null?d.toLowerCase():void 0;return a!=null&&k.call(b.CONTAINER_ELEMENTS,a)>=0},isBlockNode:function(a){var d,a=(d=a.tagName)!=null?d.toLowerCase():void 0;return a!=null&&k.call(b.BLOCK_ELEMENTS,a)>=0},isCloseNode:function(a){var d,a=(d=a.tagName)!=null?d.toLowerCase():void 0;return a!=null&&k.call(b.CLOSE_ELEMENTS,
a)>=0},isInlineNode:function(a){return!(b.isContainerNode(a)||b.isBlockNode(a)||b.isDataNode(a))},isDataNode:function(a){return a!=null&&a.nodeType===3},isVisibleNode:function(a){var d,e,c;if(b.isDataNode(a))return a=b.getTextContent(a).replace(/[\s\t\r\n]/g,""),a.length!==0;else{c=a.childNodes;for(d=0,e=c.length;d<e;d++)if(a=c[d],!b.isVisibleNode(a))return false;return true}},isIsolateNode:function(a){return!a.nextSibling&&!a.previousSibling},isAncestorOf:function(a,d){return!b.isDataNode(a)&&(a.contains(b.isDataNode(d)?
d.parentNode:d)||d.parentNode===a)},isAncestorOrSelf:function(a,d){return a===d||b.isAncestorOf(a,d)},isEqual:function(a,d){var e,c,f,g;return a!=null&&d!=null&&a.nodeType===d.nodeType?b.isDataNode(a)?b.getTextContent(a)===b.getTextContent(d):(f=function(a,b){var d,c;if(a instanceof Object&&b instanceof Object)for(d in a){if(c=a[d],f(c,b[d]))return false}else if(a instanceof Array&&b instanceof Array){if(a.length!==b.length)return false;for(d=0,c=a.length;0<=c?d<c:d>c;0<=c?d++:d--)if(a[d]!==b[d])return false}else if(a!==
b)return false;return true},e=((c=a.tagName)!=null?c.toLowerCase():void 0)===((g=d.tagName)!=null?g.toLowerCase():void 0),c=f(a.styles,d.styles),e&&c):false},createElementFromHTML:function(a){var b;b=document.createElement("div");b.innerHTML=a;return b.firstChild},getTextContent:function(a){return a.textContent||a.nodeValue},setTextContent:function(a,b){return a.textContent!=null?a.textContent=b:a.nodeValue=b},getNodeLength:function(a){return b.isDataNode(a)?a.length:a.childNodes.length},findClosestAncestor:function(a,
d){if(b.isAncestorOf(a,d))for(;d&&d.parentNode!==a;)d=d.parentNode;return d},findChildPosition:function(a){var b;for(b=0;(a=a.previousSibling)!=null;)b++;return b},findUpstreamNode:function(a,b,e){for(var c;a!=null;){if(c=b(a))return a;a=a.parentNode;if(e!=null&&e(a))break}return null},findTerminalNode:function(a,b){b==null&&(b=false);if(b)for(;a!=null&&a.lastChild!=null;)a=a.lastChild;else for(;a!=null&&a.firstChild!=null;)a=a.firstChild;return a},findNextNode:function(a){a=b.findUpstreamNode(a,
function(a){return a.nextSibling!=null});return a!=null?a.nextSibling:void 0},findPreviousNode:function(a){a=b.findUpstreamNode(a,function(a){return a.previousSibling!=null});return a!=null?a.previousSibling:void 0},findNextTerminalNode:function(a){a=b.findNextNode(a);return a=b.findTerminalNode(a)},findPreviousTerminalNode:function(a){a=b.findPreviousNode(a);return a=b.findTerminalNode(a,true)},applyToAllTerminalNodes:function(a,d,e){var c,f,a=b.findTerminalNode(a),d=b.findTerminalNode(d);for(f=
[];a!=null;){c=b.findNextTerminalNode(a);e(a);if(a===d)break;f.push(a=c)}return f},splitDataNode:function(a,d){var e;if(!b.isDataNode(a))return false;e=a.cloneNode(false);a.deleteData(d,a.length);e.deleteData(0,d);a.parentNode.insertBefore(e,a.nextSibling);return e},extractDataNode:function(a,d,e){var c,f,g,h;d==null&&(d=void 0);e==null&&(e=void 0);if(!b.isDataNode(a))return false;f=b.getTextContent(a);d==null&&(d=0);if(e==null)e=f.length;if(d===e||d===0&&e===f.length)return a;c=f.substring(0,d);
d=f.substring(d,e);g=f.substring(e,f.length);e=a.nextSibling;f=a.parentNode;f.removeChild(a);a=document;c.length>0&&(c=a.createTextNode(c),b.isVisibleNode(c)&&f.insertBefore(c,e));d.length>0&&(h=a.createTextNode(d),f.insertBefore(h,e));g.length>0&&(c=a.createTextNode(g),b.isVisibleNode(c)&&f.insertBefore(c,e));return h},concatDataNode:function(a,d){a.parentNode.removeChild(d);b.setTextContent(a,b.getTextContent(a)+b.getTextContent(d));return a},concatNode:function(a,b){for(b.parentNode.removeChild(b);b.firstChild!=
null;)a.appendChild(b.firstChild);return a}};n={_tidyInline:function(a){var d,e,c,f;d={b:"strong",i:"em",u:"ins",s:"del"};for(e in d)if(f=d[e],a.tagName.toLowerCase()===e){a=h.replace(a,document.createElement(f));break}c=a.firstChild;for(d=[];c!=null;)a=c.nextSibling,b.isContainerNode(c)?(f=function(a){return b.isContainerNode(a)},e=b.findUpstreamNode(c,f),f=c.cloneNode(false),h.remove(c),h._container(e,f)):b.isBlockNode(c)?(f=function(a){return b.isContainerNode(a)},e=b.findUpstreamNode(c,f),f=c.cloneNode(false),
h.remove(c),h._block(e,f)):b.isInlineNode(c)&&(f=function(a){return b.isEqual(a,c)},e=function(a){return!b.isInlineNode(a)},e=b.findUpstreamNode(c.parentNode,f,e),e!=null&&h.remove(c)),b.isInlineNode(c)&&n._tidyInline(c),d.push(c=a);return d},_tidyBlock:function(a){var d,e,c,f,a=a.firstChild;for(f=[];a!=null;){e=a.nextSibling;if(b.isContainerNode(a))d=function(a){return b.isContainerNode(a)},d=b.findUpstreamNode(a,d),c=a.cloneNode(false),h.remove(a),h._container(d,c);else if(b.isBlockNode(a))d=function(a){return b.isContainerNode(a)},
d=b.findUpstreamNode(a,d),c=a.cloneNode(false),h.remove(a),h._block(d,c);else if(e!=null)if(b.isDataNode(a)&&b.isDataNode(e)){a=b.concatDataNode(a,e);continue}else if(b.isInlineNode(a)&&b.isInlineNode(e)&&!b.isCloseNode(a)&&b.isEqual(a,e)){a=b.concatNode(a,e);continue}b.isBlockNode(a)?n._tidyBlock(a):b.isInlineNode(a)&&n._tidyInline(a);f.push(a=e)}return f},_tidyContainer:function(a){var d,e,c,a=a.firstChild;for(c=[];a!=null;){e=a.nextSibling;if(b.isContainerNode(a)||b.isBlockNode(a)){if(!b.isDataNode(e)||
k.call(b.getTextContent(e),"\n")<0)d=document.createTextNode("\n"),a.parentNode.insertBefore(d,e)}else if(b.isVisibleNode(a)){a=h.out(a,document.createElement("p"));continue}b.isContainerNode(a)?n._tidyContainer(a):b.isBlockNode(a)&&n._tidyBlock(a);c.push(a=e)}return c},tidy:function(a,b){var e,c,f,h,i,j,k;k=new g(b);h=k.getSelection();if(h.rangeCount>0)f=h.getRangeAt(0),i=f.startContainer,j=f.startOffset,e=f.endContainer,c=f.endOffset,h.removeAllRanges();n._tidyContainer(a);if(i!=null)return f=k.createRange(),
f.setStart(i,j),f.setEnd(e,c),k.setSelection(f)}};g=function(){function a(a){var b;this.document=a;this.window=this.document.defaultView||this.document.parentWindow;if(this.document.createRange==null&&window.IERange!=null)this.document.createRange=m(function(){return new IERange(this.document)},this),b=new IESelection(this.document),this.window.getSelection=m(function(){this.document.body.focus();return b},this)}a.prototype.getSelection=function(){return this.window.getSelection()};a.prototype.setSelection=
function(a){var b;b=this.getSelection();b.removeAllRanges();return b.addRange(a)};a.prototype.getRangeAt=function(a){return this.getSelection().getRangeAt(a)};a.prototype.createRange=function(){return this.document.createRange()};return a}();o=function(){function a(a,b,c,f){this.startContainer=a;this.startOffset=b;this.endContainer=c;this.endOffset=f}a.prototype.setStart=function(a,b){b==null&&(b=0);this.startContainer=a;return this.startOffset=b};a.prototype.setEnd=function(a,b){var c;if(b==null)a.firstChild!=
null?b=a.childNodes.length:(c=a.textContent||a.nodeValue,b=c.length);this.endContainer=a;return this.endOffset=b};a.prototype.attach=function(a){a.setStart(this.startContainer,this.startOffset);a.setEnd(this.endContainer,this.endOffset);return a};return a}();h={out:function(a,b){var e,c,b=b.cloneNode(false);e=a.nextSibling;c=a.parentNode;b.appendChild(a);c.insertBefore(b,e);return b},"in":function(a,b){for(b=b.cloneNode(false);a.firstChild!=null;)b.appendChild(a.firstChild);a.appendChild(b);return a},
replace:function(a,b){for(var e,b=b.cloneNode(false);a.firstChild;)b.appendChild(a.firstChild);e=a.parentNode;e.insertBefore(b,a);e.removeChild(a);return b},remove:function(a){var b,e;b=a.nextSibling;e=a.parentNode;for(e.removeChild(a);a.firstChild;)e.insertBefore(a.firstChild,b);return e},each:function(a,d,e,c,f){c==null&&(c=[]);if(f==null)f=h.out;return b.applyToAllTerminalNodes(a,d,function(a){if(k.call(c,a)<0&&b.isVisibleNode(a))return f(a,e)})},research:function(a,d,e,c){var f,h,g;c==null&&(c=
[]);f=e.tagName.toLowerCase();g=function(a){var b;return((b=a.tagName)!=null?b.toLowerCase():void 0)===f};h=[];b.applyToAllTerminalNodes(a,d,function(a){var d;if(k.call(c,a)<0&&b.isVisibleNode(a))return d=b.findUpstreamNode(a,g),h.push({node:a,found:d})});return h},_container:function(a,d){var e;e=b.findUpstreamNode(a,function(a){return b.isBlockNode(a)&&b.isContainerNode(a.parentNode)});a=h.out(e,d);e=new o;e.setStart(a);e.setEnd(a);return e},_containerRemove:function(a,d){var e,c,f;c=b.findUpstreamNode(a,
function(a){return b.isEqual(a,d)});c!=null?(f=b.findPreviousNode(c),e=b.findNextNode(c),h.remove(c),c=new o,c.setStart(b.findNextNode(f)),c.setEnd(b.findPreviousNode(e))):(c=new o,c.setStart(a),c.setEnd(a));return c},_block:function(a,d,e){var c;e==null&&(e=true);c=b.findUpstreamNode(a,function(a){return b.isBlockNode(a)});if(c!=null)if(b.isEqual(c,d))if(e)a=h.replace(c,document.createElement("p"));else return d=b.findPreviousNode(c),a=b.findNextNode(c),h.remove(c),c=new o,c.setStart(b.findNextNode(d)),
c.setEnd(b.findPreviousNode(a)),c;else a=h.replace(c,d);else c=b.findUpstreamNode(a,function(a){return b.isContainerNode(a)}),a=h["in"](c,d);c=new o;c.setStart(a);c.setEnd(a);return c},_inline:function(a,d,e,c){var f,g,i,j,k,a=b.findUpstreamNode(a,function(a){return b.isEqual(a,c)});if(a!=null){if(g=a.firstChild,i=b.findNextTerminalNode(a.lastChild),a=h.remove(a),f=[],b.applyToAllTerminalNodes(d,e,function(a){return f.push(a)}),h.each(g,i,c,f),d===e&&b.isDataNode(d)&&(i=d.previousSibling,i!=null&&
b.isDataNode(i)))return g=d,d=i!=null?i.length:0,e=d+g.length,g=b.concatDataNode(i,g),i=new o,i.setStart(g,d),i.setEnd(g,e),i}else{i=h.research(d,e,c);a=true;for(j=0,k=i.length;j<k;j++)if(g=i[j],g.found==null){a=false;break}if(a)for(a=0,j=i.length;a<j;a++)g=i[a],g.found!=null&&h.remove(g.found);else for(a=0,j=i.length;a<j;a++)g=i[a],g.found==null&&h.out(g.node,c)}i=new o;i.setStart(d);i.setEnd(e);return i},range:function(a,d,e){var c,f,g;e==null&&(e=false);return b.isContainerNode(d)?e?h._containerRemove(a.commonAncestorContainer,
d):h._container(a.commonAncestorContainer,d):b.isBlockNode(d)?h._block(a.commonAncestorContainer,d):(f=a.startContainer,g=a.startOffset,e=a.endContainer,c=a.endOffset,a=a.commonAncestorContainer,f===e&&b.isDataNode(f)?(f=e=b.extractDataNode(f,g,c),a=f.parentNode):(f=b.isDataNode(f)?b.extractDataNode(f,g):f.childNodes[g],e=b.isDataNode(e)?b.extractDataNode(e,null,c):e.childNodes[c-1]),h._inline(a,f,e,d))}};l=function(){function a(b){this.iframe=b;a.__super__.constructor.call(this,null);this.iframe.attachEvent!=
null?i.bind(this.iframe,"onreadystatechange",m(function(){if(this.iframe.readyState==="complete")return i.unbind(this.iframe,"onreadystatechange",arguments.callee),this.fire("ready")},this)):i.bind(this.iframe,"load",m(function(){return this.fire("ready")},this));this.bind("ready",m(function(){var a;this.window=this.iframe.contentWindow;this.document=this.iframe.contentDocument||this.window.document;this.document.body==null&&this.document.writeln("<body></body>");this.body=this.document.body;this.body.style.cursor=
"text";this.body.style.height="100%";Richarea.detector.browser==="Explorer"&&Richarea.detector.version<9&&(a=m(function(){return this.body.style.height=""+this.iframe.offsetHeight+"px"},this),setTimeout(m(function(){var b,d;((b=this.iframe)!=null?b.offsetHeight:void 0)!==((d=this.body)!=null?d.offsetHeight:void 0)&&a();return setTimeout(arguments.callee,100)},this),100));if(this.body.spellcheck!=null)this.body.spellcheck=false;if(this.body.contentEditable!=null)this.body.contentEditable=true;else if(this.document.designMode!=
null)this.document.designMode="On";i.bind(this.body,"focus click dblclick keydown keypress keyup blur paste",m(function(a){a.target=this;return this.fire(a)},this));this.bind("focus",m(function(){return this.iframe.setAttribute("previousContent",this.getValue())},this));return this.bind("focus click dblclick keydown keyup paste blur",m(function(){return this.update()},this))},this))}r(a,i);a.prototype.ready=function(a){return this.window!=null?a({type:"ready",target:this}):this.bind("ready",a)};a.prototype.update=
function(){var a;a=this.iframe.getAttribute("previousContent");if(this.getValue()!==a)return this.fire({type:"change",previous:a}),this.iframe.setAttribute("previousContent",this.getValue())};a.prototype.getValue=function(){if(this.window!=null)return this.body.innerHML};a.prototype.setValue=function(a){if(this.window!=null)return this.body.innerHTML=a,this.update()};return a}();this.Richarea=function(){function a(b){this.iframe=b;a.__super__.constructor.call(this,null);this.raw=new l(this.iframe);
this.raw.ready(m(function(){this.selection=new g(this.raw.document);this.raw.bind("focus click dblclick keydown keypress keyup paste blur change",m(function(a){a.target=this;return this.fire(a)},this));this.bind("change",m(function(){return this.tidy()},this));return this.tidy()},this))}r(a,i);a.detector=new p;a.prototype.tidy=function(){return n.tidy(this.raw.body,this.raw.document)};a.prototype.ready=function(a){return this.raw.ready(a)};a.prototype.getValue=function(){return this.raw.getValue()};
a.prototype.setValue=function(a){return this.raw.setValue(a)};a.prototype.execCommand=function(){return this.raw.update()};a.prototype.getPath=function(){var a,e;a=this.selection.getSelection();if(a.rangeCount>0){a=a.getRangeAt(0);a=a.commonAncestorContainer;for(e=[];a!=null&&a.toString()!=="[object HTMLBodyElement]";)b.isDataNode(a)||e.push(a.tagName),a=a.parentNode;return e=e.reverse()}return[]};a.prototype.getSelection=function(){return this.selection.getSelection()};a.prototype.setSelection=function(a){return this.selection.setSelection(a)};
a.prototype.getSelectedContent=function(){var a;a=this.getSelection();return a.rangeCount>0&&!a.isCollapsed?(a=a.getRangeAt(0),a.cloneContents()):null};a.prototype.replaceSelection=function(a,e){var c,f;e==null&&(e=true);f=this.getSelection();if(f.rangeCount>0)return a=b.createElementFromHTML(a),c=f.getRangeAt(0),f.removeAllRanges(),c.extractContents(),c.insertNode(a),c=this.selection.createRange(),c.selectNode(a),e||c.collapse(false),this.setSelection(c),this.raw.update()};a.prototype.insertBeforeSelection=
function(a,e){var c,f;e==null&&(e=true);c=this.getSelection();if(c.rangeCount>0)return a=b.createElementFromHTML(a),f=c.getRangeAt(0),c.removeAllRanges(),c=f.extractContents(),f.insertNode(c),f.insertNode(a),f=this.selection.createRange(),f.setStartBefore(c,0),f.setEndAfter(a,b.getNodeLength(a)),e||f.collapse(false),this.setSelection(f),this.raw.update()};a.prototype.insertAfterSelection=function(a,e){var c,f;e==null&&(e=true);c=this.getSelection();if(c.rangeCount>0)return a=b.createElementFromHTML(a),
f=c.getRangeAt(0),c.removeAllRanges(),c=f.extractContents(),f.insertNode(a),f.insertNode(c),f=this.selection.createRange(),f.setStart(a,0),f.setEnd(c,b.getNodeLength(c)),e||f.collapse(false),this.setSelection(f),this.raw.update()};a.prototype.surroundSelection=function(a,e){var c,f;e==null&&(e=true);c=this.getSelection();if(c.rangeCount>0)return a=b.createElementFromHTML(a),f=c.getRangeAt(0),c.removeAllRanges(),c=h.range(f,a),f=this.selection.createRange(),f=c.attach(f),e||f.collapse(false),this.setSelection(f),
this.raw.update()};a.prototype.unsurroundSelection=function(a,e){var c,f;e==null&&(e=true);c=this.getSelection();if(c.rangeCount>0)return a=b.createElementFromHTML(a),f=c.getRangeAt(0),c.removeAllRanges(),c=h.range(f,a,true),f=this.selection.createRange(),f=c.attach(f),e||f.collapse(false),this.setSelection(f),this.raw.update()};return a}()}).call(this);
